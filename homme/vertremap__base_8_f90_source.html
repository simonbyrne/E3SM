<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Homme: src/share/vertremap_base.F90 Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Homme
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('vertremap__base_8_f90_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">vertremap_base.F90</div>  </div>
</div><!--header-->
<div class="contents">
<a href="vertremap__base_8_f90.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#ifdef HAVE_CONFIG_H</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;config.h&quot;</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">!SUBROUTINES:</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">!Notes on Lagrange+REMAP advection</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">!dynamics will compute mean fluxes, so that (i.e. for qsplit=3)</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">!    dp(t+3)-dp(t) = -3dt div(Udp_sum/3) - 3dt d(eta_dot_dpdn_sum/3)  + 3dt D(dpdiss_sum/3)</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">!Where the floating lagrangian component:</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">!    dp_star(t+3) = dp(t)  -3dt div(Udp_sum/3)  + 3dt D(dpdiss_sum/3)</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">!OR:</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">!    dp_star(t+3) = dp(t+1) + 3dt d( eta_dot_dpdn_ave(t) )</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160; </div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160; </div>
<div class="line"><a name="l00018"></a><span class="lineno"><a class="line" href="namespacevertremap__base.html">   18</a></span>&#160;<span class="keyword">module</span> <a class="code" href="namespacevertremap__base.html">vertremap_base</a></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160; </div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;  <span class="comment">!**************************************************************************************</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;  <span class="comment">!</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;  <span class="comment">!  Purpose:</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;  <span class="comment">!        Construct sub-grid-scale polynomials using piecewise spline method with</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;  <span class="comment">!        monotone filters.</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;  <span class="comment">!</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;  <span class="comment">!  References: PCM - Zerroukat et al., Q.J.R. Meteorol. Soc., 2005. (ZWS2005QJR)</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;  <span class="comment">!              PSM - Zerroukat et al., Int. J. Numer. Meth. Fluids, 2005. (ZWS2005IJMF)</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;  <span class="comment">!</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;  <span class="comment">!**************************************************************************************</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160; </div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespacekinds.html">kinds</a>, <span class="keywordtype">only</span>                  : <a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>,<a class="code" href="namespacekinds.html#a3df43a1a47df308ae70f8f8e98d9337c">int_kind</a></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespacedimensions__mod.html">dimensions_mod</a>, <span class="keywordtype">only</span>         : <a class="code" href="namespacedimensions__mod.html#a8648e26ae0e474ccf69d32a8148520c9">np</a>,<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>,<a class="code" href="namespacedimensions__mod.html#a0070848a40ac48379601d9a8a183c83b">qsize</a>,<a class="code" href="namespacedimensions__mod.html#a311b48352dde44bfd8b73213bfc94689">nlevp</a>,<a class="code" href="namespacedimensions__mod.html#a7da46639f2907a58fa84db9c4c4401d3">npsq</a></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespacehybvcoord__mod.html">hybvcoord_mod</a>, <span class="keywordtype">only</span>          : <a class="code" href="structhybvcoord__mod_1_1hvcoord__t.html">hvcoord_t</a></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;  <span class="keywordtype">use </span>perf_mod, <span class="keywordtype">only</span>               : t_startf, t_stopf  <span class="comment">! _EXTERNAL</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespaceparallel__mod.html">parallel_mod</a>, <span class="keywordtype">only</span>           : <a class="code" href="namespaceparallel__mod.html#a00f76482d3b7bb15da165475c828f466">abortmp</a>, <a class="code" href="structparallel__mod_1_1parallel__t.html">parallel_t</a></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespacecontrol__mod.html">control_mod</a>, <span class="keywordtype">only</span> : <a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160; </div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment">! options:</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">! remap1                  ! remap any field, splines, monotone</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">! remap1_nofilter         ! remap any field, splines, no filter</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">! remap_q_ppm             ! remap state%Q, PPM, monotone</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160; </div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;  <span class="keyword">contains</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160; </div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160; </div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">!=======================================================================================================!</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160; </div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment">!remap_calc_grids computes the vertical pressures and pressure differences for one vertical column for the reference grid</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment">!and for the deformed Lagrangian grid. This was pulled out of each routine since it was a repeated task.</span></div>
<div class="line"><a name="l00050"></a><span class="lineno"><a class="line" href="namespacevertremap__base.html#a9d7e68ad35317ebdb785fcd1a72fc7de">   50</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="namespacevertremap__base.html#a9d7e68ad35317ebdb785fcd1a72fc7de">remap_calc_grids</a>( hvcoord , ps , dt , eta_dot_dpdn , p_lag , p_ref , dp_lag , dp_ref )</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structhybvcoord__mod_1_1hvcoord__t.html">hvcoord_t</a>)      , <span class="keywordtype">intent(in   )</span> :: hvcoord               <span class="comment">!Derived type to hold vertical sigma grid parameters</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) , <span class="keywordtype">intent(in   )</span> :: ps                    <span class="comment">!Surface pressure for this column</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) , <span class="keywordtype">intent(in   )</span> :: dt                    <span class="comment">!Time step</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) , <span class="keywordtype">intent(in   )</span> :: eta_dot_dpdn(<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1)  <span class="comment">!Looks like a vertical pressure flux</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;                                                                <span class="comment">!to compute deformed grid spacing</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) , <span class="keywordtype">intent(  out)</span> :: p_lag(<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1)         <span class="comment">!Pressures at interfaces of the Lagrangian deformed grid</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) , <span class="keywordtype">intent(  out)</span> :: p_ref(<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1)         <span class="comment">!Pressures at interfaces of the reference grid</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) , <span class="keywordtype">intent(  out)</span> :: dp_lag(<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>)          <span class="comment">!Pressure differences on Lagrangian deformed grid</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) , <span class="keywordtype">intent(  out)</span> :: dp_ref(<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>)          <span class="comment">!Pressure differences on reference grid</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  <span class="keywordtype">integer</span> :: k                                                  <span class="comment">!Iterator</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  p_ref(1) = 0  <span class="comment">!Both grids have a model top pressure of zero</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  p_lag(1) = 0  <span class="comment">!Both grids have a model top pressure of zero</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  <span class="keywordflow">do</span> k = 1 , <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    dp_ref(k) = ( hvcoord%hyai(k+1) - hvcoord%hyai(k) ) * hvcoord%ps0 + &amp;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;         ( hvcoord%hybi(k+1) - hvcoord%hybi(k) ) * ps  <span class="comment">!Reference pressure difference</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="comment">! Lagrangian pressure difference (flux in - flux out over the time step)</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    dp_lag(k) = dp_ref(k) + dt * ( eta_dot_dpdn(k+1) - eta_dot_dpdn(k) )</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    p_ref(k+1) = p_ref(k) + dp_ref(k) <span class="comment">!Pressure at interfaces accumulated using difference over each cell</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    p_lag(k+1) = p_lag(k) + dp_lag(k) <span class="comment">!Pressure at interfaces accumulated using difference over each cell</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="namespacevertremap__base.html#a9d7e68ad35317ebdb785fcd1a72fc7de">remap_calc_grids</a></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160; </div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="comment">!=======================================================================================================!</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160; </div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160; </div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160; </div>
<div class="line"><a name="l00078"></a><span class="lineno"><a class="line" href="namespacevertremap__base.html#af3d970dd3d2368cb76531117cc4aacc4">   78</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="namespacevertremap__base.html#af3d970dd3d2368cb76531117cc4aacc4">remap1</a>(Qdp,nx,qsize,dp1,dp2)</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  <span class="comment">! remap 1 field</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  <span class="comment">! input:  Qdp   field to be remapped (NOTE: MASS, not MIXING RATIO)</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  <span class="comment">!         dp1   layer thickness (source)</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  <span class="comment">!         dp2   layer thickness (target)</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="comment">!</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="comment">! output: remaped Qdp, conserving mass, monotone on Q=Qdp/dp</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  <span class="comment">!</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nx,qsize</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="keywordtype">  real</span> (kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(inout)</span> :: qdp(nx,nx,<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>,qsize)</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="keywordtype">  real</span> (kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(in)</span> :: dp1(nx,nx,<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>),dp2(nx,nx,<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>)</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <span class="comment">! ========================</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <span class="comment">! Local Variables</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="comment">! ========================</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160; </div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="keywordtype">  real</span> (kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">dimension(nlev+1)</span>    :: rhs,lower_diag,diag,upper_diag,q_diag,zgam,z1c,z2c,zv</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="keywordtype">  real</span> (kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">dimension(nlev)</span>      :: h,qcol,dy,za0,za1,za2,zarg,zhdp,dp_star,dp_np1</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="keywordtype">  real</span> (kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>)  :: f_xm,level1,level2,level3,level4,level5, &amp;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                            peaks_min,peaks_max,tmp_cal,xm,xm_d,zv1,zv2, &amp;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;                            zero = 0,one = 1,tiny = 1e-12,qmax = 1d50</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  <span class="keywordtype">integer(kind=int_kind)</span> :: zkr(nlev+1),filter_code(nlev),peaks,im1,im2,im3,ip1,ip2, &amp;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;                            lt1,lt2,lt3,t0,t1,t2,t3,t4,tm,tp,ie,i,ilev,j,jk,k,q</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="keywordtype">logical</span> :: abort=.false.</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160; </div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  q = <a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <span class="keywordflow">if</span> ( (q.ne.-1) .and. (q.ne.0) .and. (q.ne.1) .and. (q.ne.2) .and. (q.ne.3) .and. (q.ne.10) )&amp;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;     <span class="keyword">call </span><a class="code" href="namespaceparallel__mod.html#a00f76482d3b7bb15da165475c828f466">abortmp</a>(<span class="stringliteral">&#39;Bad vert_remap_q_alg value. Use -1, 0, 1, 2, 3, or 10.&#39;</span>)</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160; </div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a> == -1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;     <span class="keyword">call </span><a class="code" href="namespacevertremap__base.html#a18cc0d3392ace9aa5e0dc0894122dcfd">remap1_nofilter</a>(qdp,nx,qsize,dp1,dp2)</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;     <span class="keywordflow">return</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a> == 1 .or. <a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a> == 2 .or. <a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a> == 3 .or. <a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a> == 10) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;     <span class="keyword">call </span><a class="code" href="namespacevertremap__base.html#adb17ab316da43ce978d5e856fb85b132">remap_q_ppm</a>(qdp,nx,qsize,dp1,dp2)</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;     <span class="keywordflow">return</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160; </div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <span class="keyword">call </span>t_startf(<span class="stringliteral">&#39;remap_Q_noppm&#39;</span>)</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="preprocessor">#if (defined COLUMN_OPENMP)</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="preprocessor"></span><span class="comment">!$omp parallel do private(q,i,j,z1c,z2c,zv,k,dp_np1,dp_star,Qcol,zkr,ilev) &amp;</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment">!$omp    private(jk,zgam,zhdp,h,zarg,rhs,lower_diag,diag,upper_diag,q_diag,tmp_cal,filter_code) &amp;</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment">!$omp    private(dy,im1,im2,im3,ip1,t1,t2,t3,za0,za1,za2,xm_d,xm,f_xm,t4,tm,tp,peaks,peaks_min) &amp;</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">!$omp    private(peaks_max,ip2,level1,level2,level3,level4,level5,lt1,lt2,lt3,zv1,zv2)</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">do</span> q=1,qsize</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  <span class="keywordflow">do</span> i=1,nx</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="keywordflow">do</span> j=1,nx</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160; </div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;      z1c(1)=0 <span class="comment">! source grid</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;      z2c(1)=0 <span class="comment">! target grid</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;      <span class="keywordflow">do</span> k=1,nlev</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;         z1c(k+1)=z1c(k)+dp1(i,j,k)</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;         z2c(k+1)=z2c(k)+dp2(i,j,k)</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160; </div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;      zv(1)=0</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;      <span class="keywordflow">do</span> k=1,nlev</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        qcol(k)=qdp(i,j,k,q)<span class="comment">!  *(z1c(k+1)-z1c(k)) input is mass</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        zv(k+1) = zv(k)+qcol(k)</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160; </div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;      <span class="keywordflow">if</span> (abs(z2c(nlev+1)-z1c(nlev+1)).GE.0.000001) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        <span class="keyword">write</span>(6,*) <span class="stringliteral">&#39;SURFACE PRESSURE IMPLIED BY ADVECTION SCHEME&#39;</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        <span class="keyword">write</span>(6,*) <span class="stringliteral">&#39;NOT CORRESPONDING TO SURFACE PRESSURE IN    &#39;</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="keyword">write</span>(6,*) <span class="stringliteral">&#39;DATA FOR MODEL LEVELS&#39;</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        <span class="keyword">write</span>(6,*) <span class="stringliteral">&#39;PLEVMODEL=&#39;</span>,z2c(nlev+1)</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <span class="keyword">write</span>(6,*) <span class="stringliteral">&#39;PLEV     =&#39;</span>,z1c(nlev+1)</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        <span class="keyword">write</span>(6,*) <span class="stringliteral">&#39;DIFF     =&#39;</span>,z2c(nlev+1)-z1c(nlev+1)</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        abort=.true.</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160; </div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;      <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;      <span class="comment">!! quadratic splines with UK met office monotonicity constraints !!</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;      <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160; </div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;      zkr  = 0 <span class="comment">!99</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;      ilev = 2</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;      zkr(1) = 1</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;      zkr(nlev+1) = nlev</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;      kloop: <span class="keywordflow">do</span> k = 2,nlev</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="keywordflow">do</span> jk = ilev,nlev+1</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;          <span class="keywordflow">if</span> (z1c(jk).ge.z2c(k)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            ilev      = jk</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            zkr(k)   = jk-1</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            cycle kloop</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="keywordflow">      enddo</span> kloop</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160; </div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;      <span class="comment">!if(any(zkr==0)) then</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;      <span class="comment">!  write(6,*) &quot;Invalid zkr values in remap1.&quot;</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;      <span class="comment">!  abort=.true.</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;      <span class="comment">!endif</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160; </div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;      zgam  = (z2c(1:nlev+1)-z1c(zkr)) / (z1c(zkr+1)-z1c(zkr))</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;      zgam(1)      = 0.0</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;      zgam(nlev+1) = 1.0</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;      zhdp = z1c(2:nlev+1)-z1c(1:nlev)</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160; </div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160; </div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;      h = 1/zhdp</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;      zarg = qcol * h</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;      rhs = 0</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;      lower_diag = 0</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;      diag = 0</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;      upper_diag = 0</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160; </div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;      rhs(1)=3*zarg(1)</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;      rhs(2:nlev) = 3*(zarg(2:nlev)*h(2:nlev) + zarg(1:nlev-1)*h(1:nlev-1))</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;      rhs(nlev+1)=3*zarg(nlev)</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160; </div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;      lower_diag(1)=1</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;      lower_diag(2:nlev) = h(1:nlev-1)</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;      lower_diag(nlev+1)=1</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160; </div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;      diag(1)=2</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;      diag(2:nlev) = 2*(h(2:nlev) + h(1:nlev-1))</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;      diag(nlev+1)=2</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160; </div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;      upper_diag(1)=1</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;      upper_diag(2:nlev) = h(2:nlev)</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;      upper_diag(nlev+1)=0</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160; </div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      q_diag(1)=-upper_diag(1)/diag(1)</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;      rhs(1)= rhs(1)/diag(1)</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160; </div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;      <span class="keywordflow">do</span> k=2,nlev+1</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        tmp_cal    =  1/(diag(k)+lower_diag(k)*q_diag(k-1))</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        q_diag(k) = -upper_diag(k)*tmp_cal</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        rhs(k) =  (rhs(k)-lower_diag(k)*rhs(k-1))*tmp_cal</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;      <span class="keywordflow">do</span> k=nlev,1,-1</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        rhs(k)=rhs(k)+q_diag(k)*rhs(k+1)</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160; </div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;      <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;      <span class="comment">!!  monotonicity modifications  !!</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;      <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160; </div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;      filter_code = 0</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;      dy(1:nlev-1) = zarg(2:nlev)-zarg(1:nlev-1)</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;      dy(nlev) = dy(nlev-1)</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160; </div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;      dy = merge(zero, dy, abs(dy) &lt; tiny )</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160; </div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;      <span class="keywordflow">do</span> k=1,nlev</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        im1=max(1,k-1)</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        im2=max(1,k-2)</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        im3=max(1,k-3)</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        ip1=min(nlev,k+1)</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        t1 = merge(1,0,(zarg(k)-rhs(k))*(rhs(k)-zarg(im1)) &gt;= 0)</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        t2 = merge(1,0,dy(im2)*(rhs(k)-zarg(im1)) &gt; 0 .AND. dy(im2)*dy(im3) &gt; 0 &amp;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;             .AND. dy(k)*dy(ip1) &gt; 0 .AND. dy(im2)*dy(k) &lt; 0 )</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        t3 = merge(1,0,abs(rhs(k)-zarg(im1)) &gt; abs(rhs(k)-zarg(k)))</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160; </div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        filter_code(k) = merge(0,1,t1+t2 &gt; 0)</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        rhs(k) = (1-filter_code(k))*rhs(k)+filter_code(k)*(t3*zarg(k)+(1-t3)*zarg(im1))</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        filter_code(im1) = max(filter_code(im1),filter_code(k))</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160; </div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;      rhs = merge(qmax,rhs,rhs &gt; qmax)</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;      rhs = merge(zero,rhs,rhs &lt; zero)</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160; </div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;      za0 = rhs(1:nlev)</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;      za1 = -4*rhs(1:nlev) - 2*rhs(2:nlev+1) + 6*zarg</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;      za2 =  3*rhs(1:nlev) + 3*rhs(2:nlev+1) - 6*zarg</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160; </div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;      dy(1:nlev) = rhs(2:nlev+1)-rhs(1:nlev)</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;      dy = merge(zero, dy, abs(dy) &lt; tiny )</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160; </div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;      <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;      <span class="comment">!! Compute the 3 quadratic spline coeffients {za0, za1, za2}                 !!</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;      <span class="comment">!! knowing the quadratic spline parameters {rho_left,rho_right,zarg}         !!</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;      <span class="comment">!! Zerroukat et.al., Q.J.R. Meteorol. Soc., Vol. 128, pp. 2801-2820 (2002).   !!</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;      <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160; </div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160; </div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;      h = rhs(2:nlev+1)</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160; </div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;      <span class="keywordflow">do</span> k=1,nlev</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        xm_d = merge(one,2*za2(k),abs(za2(k)) &lt; tiny)</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        xm = merge(zero,-za1(k)/xm_d, abs(za2(k)) &lt; tiny)</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        f_xm = za0(k) + za1(k)*xm + za2(k)*xm**2</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160; </div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        t1 = merge(1,0,abs(za2(k)) &gt; tiny)</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        t2 = merge(1,0,xm &lt;= zero .OR. xm &gt;= 1)</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        t3 = merge(1,0,za2(k) &gt; zero)</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        t4 = merge(1,0,za2(k) &lt; zero)</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        tm = merge(1,0,t1*((1-t2)+t3) .EQ. 2)</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        tp = merge(1,0,t1*((1-t2)+(1-t3)+t4) .EQ. 3)</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160; </div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        peaks=0</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        peaks = merge(-1,peaks,tm .EQ. 1)</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        peaks = merge(+1,peaks,tp .EQ. 1)</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        peaks_min = merge(f_xm,min(za0(k),za0(k)+za1(k)+za2(k)),tm .EQ. 1)</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        peaks_max = merge(f_xm,max(za0(k),za0(k)+za1(k)+za2(k)),tp .EQ. 1)</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160; </div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        im1=max(1,k-1)</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        im2=max(1,k-2)</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        ip1=min(nlev,k+1)</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        ip2=min(nlev,k+2)</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160; </div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        t1 = merge(abs(peaks),0,(dy(im2)*dy(im1) &lt;= tiny) .OR. &amp;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;             (dy(ip1)*dy(ip2) &lt;= tiny) .OR. (dy(im1)*dy(ip1) &gt;= tiny) .OR. &amp;</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;             (dy(im1)*float(peaks) &lt;= tiny))</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160; </div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        filter_code(k) = merge(1,t1+(1-t1)*filter_code(k),(rhs(k) &gt;= qmax) .OR. &amp;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;             (rhs(k) &lt;= zero) .OR. (peaks_max &gt; qmax) .OR. (peaks_min &lt; tiny))</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160; </div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        <span class="keywordflow">if</span> (filter_code(k) &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;          level1 = rhs(k)</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;          level2 = (2*rhs(k)+h(k))/3</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;          level3 = 0.5*(rhs(k)+h(k))</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;          level4 = (1/3d0)*rhs(k)+2*(1/3d0)*h(k)</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;          level5 = h(k)</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160; </div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;          t1 = merge(1,0,h(k) &gt;= rhs(k))</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;          t2 = merge(1,0,zarg(k) &lt;= level1 .OR.  zarg(k) &gt;= level5)</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;          t3 = merge(1,0,zarg(k) &gt;  level1 .AND. zarg(k) &lt;  level2)</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;          t4 = merge(1,0,zarg(k) &gt;  level4 .AND. zarg(k) &lt;  level5)</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160; </div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;          lt1 = t1*t2</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;          lt2 = t1*(1-t2+t3)</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;          lt3 = t1*(1-t2+1-t3+t4)</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160; </div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;          za0(k) = merge(zarg(k),za0(k),lt1 .EQ. 1)</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;          za1(k) = merge(zero,za1(k),lt1 .EQ. 1)</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;          za2(k) = merge(zero,za2(k),lt1 .EQ. 1)</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160; </div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;          za0(k) = merge(rhs(k),za0(k),lt2 .EQ. 2)</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;          za1(k) = merge(zero,za1(k),lt2 .EQ. 2)</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;          za2(k) = merge(3*(zarg(k)-rhs(k)),za2(k),lt2 .EQ. 2)</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160; </div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;          za0(k) = merge(-2*h(k)+3*zarg(k),za0(k),lt3 .EQ. 3)</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;          za1(k) = merge(+6*h(k)-6*zarg(k),za1(k),lt3 .EQ. 3)</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;          za2(k) = merge(-3*h(k)+3*zarg(k),za2(k),lt3 .EQ. 3)</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160; </div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;          t2 = merge(1,0,zarg(k) &gt;= level1 .OR.  zarg(k) &lt;= level5)</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;          t3 = merge(1,0,zarg(k) &lt;  level1 .AND. zarg(k) &gt;  level2)</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;          t4 = merge(1,0,zarg(k) &lt;  level4 .AND. zarg(k) &gt;  level5)</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160; </div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;          lt1 = (1-t1)*t2</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;          lt2 = (1-t1)*(1-t2+t3)</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;          lt3 = (1-t1)*(1-t2+1-t3+t4)</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160; </div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;          za0(k) = merge(zarg(k),za0(k),lt1 .EQ. 1)</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;          za1(k) = merge(zero,za1(k),lt1 .EQ. 1)</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;          za2(k) = merge(zero,za2(k),lt1 .EQ. 1)</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160; </div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;          za0(k) = merge(rhs(k),za0(k),lt2 .EQ. 2)</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;          za1(k) = merge(zero,za1(k),lt2 .EQ. 2)</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;          za2(k) = merge(3*(zarg(k)-rhs(k)),za2(k),lt2 .EQ. 2)</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160; </div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;          za0(k) = merge(-2*h(k)+3*zarg(k),za0(k),lt3 .EQ. 3)</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;          za1(k) = merge(+6*h(k)-6*zarg(k),za1(k),lt3 .EQ. 3)</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;          za2(k) = merge(-3*h(k)+3*zarg(k),za2(k),lt3 .EQ. 3)</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160; </div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;      <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;      <span class="comment">!! start iteration from top to bottom of atmosphere !!</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;      <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160; </div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;      zv1 = 0</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;      <span class="keywordflow">do</span> k=1,nlev</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        <span class="keywordflow">if</span> (zgam(k+1)&gt;1d0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;          <span class="keyword">WRITE</span>(*,*) <span class="stringliteral">&#39;r not in [0:1]&#39;</span>, zgam(k+1)</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;          abort=.true.</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        zv2 = zv(zkr(k+1))+(za0(zkr(k+1))*zgam(k+1)+(za1(zkr(k+1))/2)*(zgam(k+1)**2)+ &amp;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;             (za2(zkr(k+1))/3)*(zgam(k+1)**3))*zhdp(zkr(k+1))</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        qdp(i,j,k,q) = (zv2 - zv1) <span class="comment">! / (z2c(k+1)-z2c(k) ) dont convert back to mixing ratio</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        zv1 = zv2</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! q loop</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;  <span class="keywordflow">if</span> (abort) <span class="keyword">call </span><a class="code" href="namespaceparallel__mod.html#a00f76482d3b7bb15da165475c828f466">abortmp</a>(<span class="stringliteral">&#39;Bad levels in remap1.  usually CFL violatioin&#39;</span>)</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;  <span class="keyword">call </span>t_stopf(<span class="stringliteral">&#39;remap_Q_noppm&#39;</span>)</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160; </div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="namespacevertremap__base.html#af3d970dd3d2368cb76531117cc4aacc4">remap1</a></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160; </div>
<div class="line"><a name="l00361"></a><span class="lineno"><a class="line" href="namespacevertremap__base.html#a18cc0d3392ace9aa5e0dc0894122dcfd">  361</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="namespacevertremap__base.html#a18cc0d3392ace9aa5e0dc0894122dcfd">remap1_nofilter</a>(Qdp,nx,qsize,dp1,dp2)</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;  <span class="comment">! remap 1 field</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;  <span class="comment">! input:  Qdp   field to be remapped (NOTE: MASS, not MIXING RATIO)</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;  <span class="comment">!         dp1   layer thickness (source)</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;  <span class="comment">!         dp2   layer thickness (target)</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  <span class="comment">!</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;  <span class="comment">! output: remaped Qdp, conserving mass</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;  <span class="comment">!</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;  <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nx,qsize</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="keywordtype">  real</span> (kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(inout)</span> :: qdp(nx,nx,<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>,qsize)</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="keywordtype">  real</span> (kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(in)</span> :: dp1(nx,nx,<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>),dp2(nx,nx,<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>)</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;  <span class="comment">! ========================</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;  <span class="comment">! Local Variables</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;  <span class="comment">! ========================</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160; </div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="keywordtype">  real</span> (kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">dimension(nlev+1)</span>    :: rhs,lower_diag,diag,upper_diag,q_diag,zgam,z1c,z2c,zv</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="keywordtype">  real</span> (kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">dimension(nlev)</span>      :: h,qcol,dy,za0,za1,za2,zarg,zhdp,dp_star,dp_np1</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="keywordtype">  real</span> (kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>)  :: f_xm,level1,level2,level3,level4,level5, &amp;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                            peaks_min,peaks_max,tmp_cal,xm,xm_d,zv1,zv2, &amp;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                            zero = 0,one = 1,tiny = 1e-12,qmax = 1d50</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;  <span class="keywordtype">integer(kind=int_kind)</span> :: zkr(nlev+1),filter_code(nlev),peaks,im1,im2,im3,ip1,ip2, &amp;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                            lt1,lt2,lt3,t0,t1,t2,t3,t4,tm,tp,ie,i,ilev,j,jk,k,q</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;  <span class="keywordtype">logical</span> :: abort=.false.</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="comment">!   call t_startf(&#39;remap1_nofilter&#39;)</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160; </div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="preprocessor">#if (defined COLUMN_OPENMP)</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="preprocessor"></span><span class="comment">!$omp parallel do private(q,i,j,z1c,z2c,zv,k,dp_np1,dp_star,Qcol,zkr,ilev) &amp;</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="comment">!$omp    private(jk,zgam,zhdp,h,zarg,rhs,lower_diag,diag,upper_diag,q_diag,tmp_cal,filter_code) &amp;</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="comment">!$omp    private(dy,im1,im2,im3,ip1,t1,t2,t3,za0,za1,za2,xm_d,xm,f_xm,t4,tm,tp,peaks,peaks_min) &amp;</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="comment">!$omp    private(peaks_max,ip2,level1,level2,level3,level4,level5,lt1,lt2,lt3,zv1,zv2)</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">do</span> q=1,qsize</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;  <span class="keywordflow">do</span> i=1,nx</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    <span class="keywordflow">do</span> j=1,nx</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160; </div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;      z1c(1)=0 <span class="comment">! source grid</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;      z2c(1)=0 <span class="comment">! target grid</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;      <span class="keywordflow">do</span> k=1,nlev</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;         z1c(k+1)=z1c(k)+dp1(i,j,k)</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;         z2c(k+1)=z2c(k)+dp2(i,j,k)</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160; </div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;      zv(1)=0</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;      <span class="keywordflow">do</span> k=1,nlev</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        qcol(k)=qdp(i,j,k,q)<span class="comment">!  *(z1c(k+1)-z1c(k)) input is mass</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        zv(k+1) = zv(k)+qcol(k)</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160; </div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;      <span class="keywordflow">if</span> (abs(z2c(nlev+1)-z1c(nlev+1)).GE.0.000001) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        <span class="keyword">write</span>(6,*) <span class="stringliteral">&#39;SURFACE PRESSURE IMPLIED BY ADVECTION SCHEME&#39;</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <span class="keyword">write</span>(6,*) <span class="stringliteral">&#39;NOT CORRESPONDING TO SURFACE PRESSURE IN    &#39;</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        <span class="keyword">write</span>(6,*) <span class="stringliteral">&#39;DATA FOR MODEL LEVELS&#39;</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <span class="keyword">write</span>(6,*) <span class="stringliteral">&#39;PLEVMODEL=&#39;</span>,z2c(nlev+1)</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        <span class="keyword">write</span>(6,*) <span class="stringliteral">&#39;PLEV     =&#39;</span>,z1c(nlev+1)</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        <span class="keyword">write</span>(6,*) <span class="stringliteral">&#39;DIFF     =&#39;</span>,z2c(nlev+1)-z1c(nlev+1)</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        abort=.true.</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160; </div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;      <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;      <span class="comment">!! quadratic splies with UK met office monotonicity constraints  !!</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;      <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160; </div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;      zkr  = 99</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;      ilev = 2</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;      zkr(1) = 1</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;      zkr(nlev+1) = nlev</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;      kloop: <span class="keywordflow">do</span> k = 2,nlev</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        <span class="keywordflow">do</span> jk = ilev,nlev+1</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;          <span class="keywordflow">if</span> (z1c(jk).ge.z2c(k)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;            ilev      = jk</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;            zkr(k)   = jk-1</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;            cycle kloop</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;<span class="keywordflow">      enddo</span> kloop</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160; </div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;      zgam  = (z2c(1:nlev+1)-z1c(zkr)) / (z1c(zkr+1)-z1c(zkr))</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;      zgam(1)      = 0.0</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;      zgam(nlev+1) = 1.0</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;      zhdp = z1c(2:nlev+1)-z1c(1:nlev)</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160; </div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160; </div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;      h = 1/zhdp</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;      zarg = qcol * h</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;      rhs = 0</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;      lower_diag = 0</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;      diag = 0</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;      upper_diag = 0</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160; </div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;      rhs(1)=3*zarg(1)</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;      rhs(2:nlev) = 3*(zarg(2:nlev)*h(2:nlev) + zarg(1:nlev-1)*h(1:nlev-1))</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;      rhs(nlev+1)=3*zarg(nlev)</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160; </div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;      lower_diag(1)=1</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;      lower_diag(2:nlev) = h(1:nlev-1)</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;      lower_diag(nlev+1)=1</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160; </div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;      diag(1)=2</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;      diag(2:nlev) = 2*(h(2:nlev) + h(1:nlev-1))</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;      diag(nlev+1)=2</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160; </div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;      upper_diag(1)=1</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;      upper_diag(2:nlev) = h(2:nlev)</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;      upper_diag(nlev+1)=0</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160; </div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;      q_diag(1)=-upper_diag(1)/diag(1)</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;      rhs(1)= rhs(1)/diag(1)</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160; </div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;      <span class="keywordflow">do</span> k=2,nlev+1</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        tmp_cal    =  1/(diag(k)+lower_diag(k)*q_diag(k-1))</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        q_diag(k) = -upper_diag(k)*tmp_cal</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        rhs(k) =  (rhs(k)-lower_diag(k)*rhs(k-1))*tmp_cal</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;      <span class="keywordflow">do</span> k=nlev,1,-1</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        rhs(k)=rhs(k)+q_diag(k)*rhs(k+1)</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160; </div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;      za0 = rhs(1:nlev)</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;      za1 = -4*rhs(1:nlev) - 2*rhs(2:nlev+1) + 6*zarg</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;      za2 =  3*rhs(1:nlev) + 3*rhs(2:nlev+1) - 6*zarg</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160; </div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160; </div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;      <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;      <span class="comment">!! start iteration from top to bottom of atmosphere !!</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;      <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160; </div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;      zv1 = 0</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;      <span class="keywordflow">do</span> k=1,nlev</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;        <span class="keywordflow">if</span> (zgam(k+1)&gt;1d0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;          <span class="keyword">WRITE</span>(*,*) <span class="stringliteral">&#39;r not in [0:1]&#39;</span>, zgam(k+1)</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;          abort=.true.</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;        zv2 = zv(zkr(k+1))+(za0(zkr(k+1))*zgam(k+1)+(za1(zkr(k+1))/2)*(zgam(k+1)**2)+ &amp;</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;             (za2(zkr(k+1))/3)*(zgam(k+1)**3))*zhdp(zkr(k+1))</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        qdp(i,j,k,q) = (zv2 - zv1) <span class="comment">! / (z2c(k+1)-z2c(k) ) dont convert back to mixing ratio</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;        zv1 = zv2</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! q loop</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;  <span class="keywordflow">if</span> (abort) <span class="keyword">call </span><a class="code" href="namespaceparallel__mod.html#a00f76482d3b7bb15da165475c828f466">abortmp</a>(<span class="stringliteral">&#39;Bad levels in remap1_nofilter.  usually CFL violatioin&#39;</span>)</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="comment">!   call t_stopf(&#39;remap1_nofilter&#39;)</span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="namespacevertremap__base.html#a18cc0d3392ace9aa5e0dc0894122dcfd">remap1_nofilter</a></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160; </div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="comment">!=======================================================================================================!</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160; </div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160; </div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="comment">!This uses the exact same model and reference grids and data as remap_Q, but it interpolates</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="comment">!using PPM instead of splines.</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment">!! vert_remap_q_alg == 1  means mirrored values in ghost cells (i.e., no flux)</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="comment">!! vert_remap_q_alg == 2  means piecewise constant in 2 cells near boundaries (don&#39;t use ghost cells)</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="comment">!! vert_remap_q_alg == 3  means UKMO splines ghost cells (copy last value into all ghost cells)</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00517"></a><span class="lineno"><a class="line" href="namespacevertremap__base.html#adb17ab316da43ce978d5e856fb85b132">  517</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="namespacevertremap__base.html#adb17ab316da43ce978d5e856fb85b132">remap_q_ppm</a>(Qdp,nx,qsize,dp1,dp2)</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;  <span class="comment">! remap 1 field</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;  <span class="comment">! input:  Qdp   field to be remapped (NOTE: MASS, not MIXING RATIO)</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;  <span class="comment">!         dp1   layer thickness (source)</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;  <span class="comment">!         dp2   layer thickness (target)</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;  <span class="comment">!</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;  <span class="comment">! output: remaped Qdp, conserving mass</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;  <span class="comment">!</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespacecontrol__mod.html">control_mod</a>, <span class="keywordtype">only</span>        : <a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;  <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;  <span class="keywordtype">integer</span>,<span class="keywordtype">intent(in)</span> :: nx,qsize</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="keywordtype">  real</span> (kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(inout)</span> :: qdp(nx,nx,<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>,qsize)</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="keywordtype">  real</span> (kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(in)</span> :: dp1(nx,nx,<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>),dp2(nx,nx,<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>)</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;  <span class="comment">! Local Variables</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: gs = 2                              <span class="comment">!Number of cells to place in the ghost region</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">dimension(       nlev+2 )</span> :: pio    <span class="comment">!Pressure at interfaces for old grid</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">dimension(       nlev+1 )</span> :: pin    <span class="comment">!Pressure at interfaces for new grid</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">dimension(       nlev+1 )</span> :: masso  <span class="comment">!Accumulate mass up to each interface</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">dimension(  1-gs:nlev+gs)</span> :: ao     <span class="comment">!Tracer value on old grid</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">dimension(  1-gs:nlev+gs)</span> :: dpo    <span class="comment">!change in pressure over a cell for old grid</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">dimension(  1-gs:nlev+gs)</span> :: dpn    <span class="comment">!change in pressure over a cell for old grid</span></div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">dimension(3,     nlev   )</span> :: coefs  <span class="comment">!PPM coefficients within each cell</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">dimension(       nlev   )</span> :: z1, z2</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) :: ppmdx(10,0:<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1)  <span class="comment">!grid spacings</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) :: mymass, massn1, massn2, ext(2)</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, q, kk, kid(nlev)</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160; </div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;  <span class="keyword">call </span>t_startf(<span class="stringliteral">&#39;remap_Q_ppm&#39;</span>)</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;  <span class="keywordflow">do</span> j = 1 , nx</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    <span class="keywordflow">do</span> i = 1 , nx</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160; </div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;      pin(1)=0</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;      pio(1)=0</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;      <span class="keywordflow">do</span> k=1,nlev</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;         dpn(k)=dp2(i,j,k)</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;         dpo(k)=dp1(i,j,k)</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;         pin(k+1)=pin(k)+dpn(k)</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;         pio(k+1)=pio(k)+dpo(k)</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160; </div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160; </div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160; </div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;      pio(nlev+2) = pio(nlev+1) + 1.  <span class="comment">!This is here to allow an entire block of k threads to run in the remapping phase.</span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                                      <span class="comment">!It makes sure there&#39;s an old interface value below the domain that is larger.</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;      pin(nlev+1) = pio(nlev+1)       <span class="comment">!The total mass in a column does not change.</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                                      <span class="comment">!Therefore, the pressure of that mass cannot either.</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;      <span class="comment">!Fill in the ghost regions with mirrored values. if vert_remap_q_alg is defined, this is of no consequence.</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;      <span class="keywordflow">do</span> k = 1 , gs</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        dpo(1   -k) = dpo(       k)</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        dpo(nlev+k) = dpo(nlev+1-k)</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160; </div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;      <span class="comment">!Compute remapping intervals once for all tracers. Find the old grid cell index in which the</span></div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;      <span class="comment">!k-th new cell interface resides. Then integrate from the bottom of that old cell to the new</span></div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;      <span class="comment">!interface location. In practice, the grid never deforms past one cell, so the search can be</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;      <span class="comment">!simplified by this. Also, the interval of integration is usually of magnitude close to zero</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;      <span class="comment">!or close to dpo because of minimial deformation.</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;      <span class="comment">!Numerous tests confirmed that the bottom and top of the grids match to machine precision, so</span></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;      <span class="comment">!I set them equal to each other.</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;      <span class="keywordflow">do</span> k = 1 , nlev</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;        kk = k  <span class="comment">!Keep from an order n^2 search operation by assuming the old cell index is close.</span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        <span class="comment">!Find the index of the old grid cell in which this new cell&#39;s bottom interface resides.</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        <span class="keywordflow">if</span> (pio(kk) &lt;= pin(k+1)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;           <span class="keywordflow">do</span> <span class="keywordflow">while</span> ( pio(kk) &lt;= pin(k+1) )</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;              kk = kk + 1</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;<span class="keywordflow">           enddo</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;           kk = kk - 1                   <span class="comment">!kk is now the cell index we&#39;re integrating over.</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;           <span class="keyword">call </span><a class="code" href="namespacevertremap__base.html#a810cc5eb21b6972ada382e2bf6c16c1e">binary_search</a>(pio, pin(k+1), kk)</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="keywordflow">        end if</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        <span class="keywordflow">if</span> (kk == nlev+1) kk = nlev   <span class="comment">!This is to keep the indices in bounds.</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                                      <span class="comment">!Top bounds match anyway, so doesn&#39;t matter what coefficients are used</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;        kid(k) = kk                   <span class="comment">!Save for reuse</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        z1(k) = -0.5d0                <span class="comment">!This remapping assumes we&#39;re starting from the left interface of an old grid cell</span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;                                      <span class="comment">!In fact, we&#39;re usually integrating very little or almost all of the cell in question</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;        z2(k) = ( pin(k+1) - ( pio(kk) + pio(kk+1) ) * 0.5 ) / dpo(kk)  <span class="comment">!PPM interpolants are normalized to an independent</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                                                                        <span class="comment">!coordinate domain [-0.5,0.5].</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160; </div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;      <span class="comment">!This turned out a big optimization, remembering that only parts of the PPM algorithm depends on the data, namely the</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;      <span class="comment">!limiting. So anything that depends only on the grid is pre-computed outside the tracer loop.</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;      ppmdx(:,:) = <a class="code" href="namespacevertremap__base.html#ab750bd38c31ca69aae4a0ad6c0f9f673">compute_ppm_grids</a>( dpo )</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160; </div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;      <span class="comment">!From here, we loop over tracers for only those portions which depend on tracer data, which includes PPM limiting and</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;      <span class="comment">!mass accumulation</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;      <span class="keywordflow">do</span> q = 1 , qsize</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        <span class="comment">!Accumulate the old mass up to old grid cell interface locations to simplify integration</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        <span class="comment">!during remapping. Also, divide out the grid spacing so we&#39;re working with actual tracer</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        <span class="comment">!values and can conserve mass. The option for ifndef ZEROHORZ I believe is there to ensure</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        <span class="comment">!tracer consistency for an initially uniform field. I copied it from the old remap routine.</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        masso(1) = 0.</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;        <span class="keywordflow">do</span> k = 1 , nlev</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;          ao(k) = qdp(i,j,k,q)</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;          masso(k+1) = masso(k) + ao(k) <span class="comment">!Accumulate the old mass. This will simplify the remapping</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;          ao(k) = ao(k) / dpo(k)        <span class="comment">!Divide out the old grid spacing because we want the tracer mixing ratio, not mass.</span></div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;        <span class="comment">!Fill in ghost values. Ignored if vert_remap_q_alg == 2</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a> &gt;= 1 .and. <a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a> &lt;= 3) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;           <span class="keywordflow">do</span> k = 1 , gs</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;              <span class="keywordflow">if</span> (<a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a> == 3) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                 ao(1   -k) = ao(1)</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                 ao(nlev+k) = ao(nlev)</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;              <span class="keywordflow">elseif</span> (<a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a> == 2 .or. <a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a> == 1)<span class="keywordflow">then</span>   <span class="comment">!Ignored if vert_remap_q_alg == 2</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                 ao(1   -k) = ao(       k)</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                 ao(nlev+k) = ao(nlev+1-k)</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;<span class="keywordflow">            enddo</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;         <span class="keywordflow">elseif</span> (<a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a> == 10) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;            ext(1) = minval(ao(1:nlev))</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;            ext(2) = maxval(ao(1:nlev))</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;            <span class="keyword">call </span><a class="code" href="namespacevertremap__base.html#a8a8647d7c357c21fa845bf0939128b45">linextrap</a>(dpo(2), dpo(1), dpo(0), dpo(-1), ao(2), ao(1), ao(0), ao(-1), ext(1), ext(2))</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;            <span class="keyword">call </span><a class="code" href="namespacevertremap__base.html#a8a8647d7c357c21fa845bf0939128b45">linextrap</a>(dpo(nlev-1), dpo(nlev), dpo(nlev+1), dpo(nlev+2),&amp;</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                 ao(nlev-1), ao(nlev), ao(nlev+1), ao(nlev+2), ext(1), ext(2))</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;<span class="keywordflow">         endif</span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        <span class="comment">!Compute monotonic and conservative PPM reconstruction over every cell</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        coefs(:,:) = <a class="code" href="namespacevertremap__base.html#a273480ce56e7f957d8110149f9161579">compute_ppm</a>( ao , ppmdx )</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        <span class="comment">!Compute tracer values on the new grid by integrating from the old cell bottom to the new</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        <span class="comment">!cell interface to form a new grid mass accumulation. Taking the difference between</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        <span class="comment">!accumulation at successive interfaces gives the mass inside each cell. Since Qdp is</span></div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        <span class="comment">!supposed to hold the full mass this needs no normalization.</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        massn1 = 0.</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;        <span class="keywordflow">do</span> k = 1 , nlev</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;          kk = kid(k)</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;          massn2 = masso(kk) + <a class="code" href="namespacevertremap__base.html#a81786cc73156c6c4062715272974bef3">integrate_parabola</a>( coefs(:,kk) , z1(k) , z2(k) ) * dpo(kk)</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;          qdp(i,j,k,q) = massn2 - massn1</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;          massn1 = massn2</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;  <span class="keyword">call </span>t_stopf(<span class="stringliteral">&#39;remap_Q_ppm&#39;</span>)</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="namespacevertremap__base.html#adb17ab316da43ce978d5e856fb85b132">remap_q_ppm</a></div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160; </div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160; </div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;<span class="comment">!THis compute grid-based coefficients from Collela &amp; Woodward 1984.</span></div>
<div class="line"><a name="l00652"></a><span class="lineno"><a class="line" href="namespacevertremap__base.html#ab750bd38c31ca69aae4a0ad6c0f9f673">  652</a></span>&#160;<span class="keyword">function </span><a class="code" href="namespacevertremap__base.html#ab750bd38c31ca69aae4a0ad6c0f9f673">compute_ppm_grids</a>( dx )   <span class="keyword">result</span>(rslt)</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;  <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(in)</span> :: dx(-1:<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+2)  <span class="comment">!grid spacings</span></div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>)             :: rslt(10,0:<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1)  <span class="comment">!grid spacings</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;  <span class="keywordtype">integer</span> :: j</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;  <span class="keywordtype">integer</span> :: indb, inde</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160; </div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;  <span class="comment">!Calculate grid-based coefficients for stage 1 of compute_ppm</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;  <span class="keywordflow">do</span> j = 0 , <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    rslt( 1,j) = dx(j) / ( dx(j-1) + dx(j) + dx(j+1) )</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    rslt( 2,j) = ( 2.*dx(j-1) + dx(j) ) / ( dx(j+1) + dx(j) )</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    rslt( 3,j) = ( dx(j) + 2.*dx(j+1) ) / ( dx(j-1) + dx(j) )</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160; </div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;  <span class="comment">!Caculate grid-based coefficients for stage 2 of compute_ppm</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;  <span class="keywordflow">do</span> j = 0 , <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    rslt( 4,j) = dx(j) / ( dx(j) + dx(j+1) )</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;    rslt( 5,j) = 1. / sum( dx(j-1:j+2) )</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    rslt( 6,j) = ( 2. * dx(j+1) * dx(j) ) / ( dx(j) + dx(j+1 ) )</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    rslt( 7,j) = ( dx(j-1) + dx(j  ) ) / ( 2. * dx(j  ) + dx(j+1) )</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    rslt( 8,j) = ( dx(j+2) + dx(j+1) ) / ( 2. * dx(j+1) + dx(j  ) )</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    rslt( 9,j) = dx(j  ) * ( dx(j-1) + dx(j  ) ) / ( 2.*dx(j  ) +    dx(j+1) )</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    rslt(10,j) = dx(j+1) * ( dx(j+1) + dx(j+2) ) / (    dx(j  ) + 2.*dx(j+1) )</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="keyword">end function </span><a class="code" href="namespacevertremap__base.html#ab750bd38c31ca69aae4a0ad6c0f9f673">compute_ppm_grids</a></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160; </div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;<span class="comment">!=======================================================================================================!</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160; </div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160; </div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160; </div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="comment">!This computes a limited parabolic interpolant using a net 5-cell stencil, but the stages of computation are broken up into 3 stages</span></div>
<div class="line"><a name="l00683"></a><span class="lineno"><a class="line" href="namespacevertremap__base.html#a273480ce56e7f957d8110149f9161579">  683</a></span>&#160;<span class="keyword">function </span><a class="code" href="namespacevertremap__base.html#a273480ce56e7f957d8110149f9161579">compute_ppm</a>( a , dx )    <span class="keyword">result</span>(coefs)</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespacecontrol__mod.html">control_mod</a>, <span class="keywordtype">only</span>: <a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;  <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(in)</span> :: a(    -1:<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+2)  <span class="comment">!Cell-mean values</span></div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(in)</span> :: dx(10,  0:<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1)  <span class="comment">!grid spacings</span></div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) ::             coefs(0:2,   <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>  )  <span class="comment">!PPM coefficients (for parabola)</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) :: ai(0:<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>  )                     <span class="comment">!fourth-order accurate, then limited interface values</span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) :: dma(0:<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1)                     <span class="comment">!An expression from Collela&#39;s &#39;84 publication</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) :: da                                <span class="comment">!Ditto</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;  <span class="comment">! Hold expressions based on the grid (which are cumbersome).</span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) :: dx1, dx2, dx3, dx4, dx5, dx6, dx7, dx8, dx9, dx10</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) :: al, ar                            <span class="comment">!Left and right interface values for cell-local limiting</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;  <span class="keywordtype">integer</span> :: j</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;  <span class="keywordtype">integer</span> :: indb, inde</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160; </div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;  <span class="comment">! Stage 1: Compute dma for each cell, allowing a 1-cell ghost stencil below and above the domain</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;  <span class="keywordflow">do</span> j = 0 , <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    da = dx(1,j) * ( dx(2,j) * ( a(j+1) - a(j) ) + dx(3,j) * ( a(j) - a(j-1) ) )</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    dma(j) = minval( (/ abs(da) , 2. * abs( a(j) - a(j-1) ) , 2. * abs( a(j+1) - a(j) ) /) ) * sign(1.d0,da)</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    <span class="keywordflow">if</span> ( ( a(j+1) - a(j) ) * ( a(j) - a(j-1) ) &lt;= 0. ) dma(j) = 0.</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160; </div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;  <span class="comment">! Stage 2: Compute ai for each cell interface in the physical domain (dimension nlev+1)</span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;  <span class="keywordflow">do</span> j = 0 , <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    ai(j) = a(j) + dx(4,j) * ( a(j+1) - a(j) ) + dx(5,j) * ( dx(6,j) * ( dx(7,j) - dx(8,j) ) &amp;</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;         * ( a(j+1) - a(j) ) - dx(9,j) * dma(j+1) + dx(10,j) * dma(j) )</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160; </div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;  <span class="comment">! Stage 3: Compute limited PPM interpolant over each cell in the physical domain</span></div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;  <span class="comment">! (dimension nlev) using ai on either side and ao within the cell.</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;  <span class="keywordflow">do</span> j = 1 , <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    al = ai(j-1)</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    ar = ai(j  )</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <span class="keywordflow">if</span> ( (ar - a(j)) * (a(j) - al) &lt;= 0. ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;      al = a(j)</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;      ar = a(j)</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    <span class="keywordflow">if</span> ( (ar - al) * (a(j) - (al + ar)/2.) &gt;  (ar - al)**2/6. ) al = 3.*a(j) - 2. * ar</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    <span class="keywordflow">if</span> ( (ar - al) * (a(j) - (al + ar)/2.) &lt; -(ar - al)**2/6. ) ar = 3.*a(j) - 2. * al</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    <span class="comment">!Computed these coefficients from the edge values and cell mean in Maple. Assumes normalized coordinates: xi=(x-x0)/dx</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    coefs(0,j) = 1.5 * a(j) - ( al + ar ) / 4.</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    coefs(1,j) = ar - al</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    <span class="comment">! coefs(2,j) = -6. * a(j) + 3. * ( al + ar )</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    coefs(2,j) = 3. * (-2. * a(j) + ( al + ar ))</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160; </div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;  <span class="comment">!If vert_remap_q_alg == 2, use piecewise constant in the boundaries, and don&#39;t use ghost cells.</span></div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">vert_remap_q_alg</a> == 2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    coefs(0,1:2) = a(1:2)</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;    coefs(1:2,1:2) = 0.</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    coefs(0,<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>-1:<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>) = a(<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>-1:<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>)</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    coefs(1:2,<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>-1:<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>) = 0.d0</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;<span class="keyword">end function </span><a class="code" href="namespacevertremap__base.html#a273480ce56e7f957d8110149f9161579">compute_ppm</a></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160; </div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;<span class="comment">!=======================================================================================================!</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160; </div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160; </div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;<span class="comment">!Simple function computes the definite integral of a parabola in normalized coordinates, xi=(x-x0)/dx,</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="comment">!given two bounds. Make sure this gets inlined during compilation.</span></div>
<div class="line"><a name="l00743"></a><span class="lineno"><a class="line" href="namespacevertremap__base.html#a81786cc73156c6c4062715272974bef3">  743</a></span>&#160;<span class="keyword">function </span><a class="code" href="namespacevertremap__base.html#a81786cc73156c6c4062715272974bef3">integrate_parabola</a>( a , x1 , x2 )    <span class="keyword">result</span>(mass)</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;  <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(in)</span> :: a(0:2)  <span class="comment">!Coefficients of the parabola</span></div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(in)</span> :: x1      <span class="comment">!lower domain bound for integration</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(in)</span> :: x2      <span class="comment">!upper domain bound for integration</span></div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>)             :: mass</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;  mass = a(0) * (x2 - x1) + a(1) * (x2 * x2 - x1 * x1) / 0.2d1 + a(2) * (x2 * x2 * x2 - x1 * x1 * x1) / 0.3d1</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="keyword">end function </span><a class="code" href="namespacevertremap__base.html#a81786cc73156c6c4062715272974bef3">integrate_parabola</a></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160; </div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160; </div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="comment">!=============================================================================================!</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160; </div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  <span class="comment">! Find k such that pio(k) &lt;= pivot &lt; pio(k+1). Provide a reasonable input</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;  <span class="comment">! value for k.</span></div>
<div class="line"><a name="l00757"></a><span class="lineno"><a class="line" href="namespacevertremap__base.html#a810cc5eb21b6972ada382e2bf6c16c1e">  757</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacevertremap__base.html#a810cc5eb21b6972ada382e2bf6c16c1e">binary_search</a>(pio, pivot, k)</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;<span class="keywordtype">    real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(in)</span> :: pio(<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+2), pivot</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(inout)</span> :: k</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    <span class="keywordtype">integer</span> :: lo, hi, mid</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160; </div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    <span class="keywordflow">if</span> (pio(k) &gt; pivot) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;       lo = 1</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;       hi = k</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;       lo = k</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;       hi = <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+2</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;<span class="keywordflow">    end if</span></div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    <span class="keywordflow">do</span> <span class="keywordflow">while</span> (hi &gt; lo + 1)</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;       k = (lo + hi)/2</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;       <span class="keywordflow">if</span> (pio(k) &gt; pivot) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;          hi = k</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;       <span class="keywordflow">else</span></div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;          lo = k</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;<span class="keywordflow">       end if</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;<span class="keywordflow">    end do</span></div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    k = lo</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacevertremap__base.html#a810cc5eb21b6972ada382e2bf6c16c1e">binary_search</a></div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160; </div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160; </div>
<div class="line"><a name="l00781"></a><span class="lineno"><a class="line" href="namespacevertremap__base.html#a8a8647d7c357c21fa845bf0939128b45">  781</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacevertremap__base.html#a8a8647d7c357c21fa845bf0939128b45">linextrap</a>(dx1,dx2,dx3,dx4,y1,y2,y3,y4,lo,hi)</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;<span class="keywordtype">    real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(in)</span> :: dx1,dx2,dx3,dx4,y1,y2,lo,hi</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="keywordtype">    real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>), <span class="keywordtype">intent(out)</span> :: y3,y4</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160; </div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;<span class="keywordtype">    real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) :: den,num,a</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;<span class="keywordtype">    real</span>(kind=<a class="code" href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">real_kind</a>) :: z3,z4</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160; </div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    <span class="comment">! In exact arithmetic, the following is equivalent to</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    <span class="comment">!   x1 = half*dx1</span></div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    <span class="comment">!   x2 = x1 + half*(dx1 + dx2)</span></div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    <span class="comment">!   x3 = x2 + half*(dx2 + dx3)</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    <span class="comment">!   x4 = x3 + half*(dx3 + dx4)</span></div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    <span class="comment">!   a  = (x3-x1)/(x2-x1)</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    <span class="comment">!   y3 = (1-a)*y1 + a*y2</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    <span class="comment">!   a  = (x4-x1)/(x2-x1)</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    <span class="comment">!   y4 = (1-a)*y1 + a*y2</span></div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="comment">! In FP, -fp-model-fast -O3 produces different results depending</span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    <span class="comment">! on whether -qopenmp is present.</span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160; </div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    den = (dx1 + dx2)/2</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    num = den + (dx2 + dx3)/2</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    a = num/den</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    y3 = (1-a)*y1 + a*y2</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160; </div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    num = num + (dx3 + dx4)/2</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    a  = num/den</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    y4 = (1-a)*y1 + a*y2</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160; </div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    y3 = max(lo, min(hi, y3))</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    y4 = max(lo, min(hi, y4))</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacevertremap__base.html#a8a8647d7c357c21fa845bf0939128b45">linextrap</a></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160; </div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160; </div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;<span class="keyword">end module </span><a class="code" href="namespacevertremap__base.html">vertremap_base</a></div>
<div class="ttc" id="anamespacecontrol__mod_html"><div class="ttname"><a href="namespacecontrol__mod.html">control_mod</a></div><div class="ttdef"><b>Definition:</b> <a href="control__mod_8_f90_source.html#l00008">control_mod.F90:8</a></div></div>
<div class="ttc" id="anamespacecontrol__mod_html_a8af0a375a0a0b8493dc65a6ef6108fc9"><div class="ttname"><a href="namespacecontrol__mod.html#a8af0a375a0a0b8493dc65a6ef6108fc9">control_mod::vert_remap_q_alg</a></div><div class="ttdeci">integer, public vert_remap_q_alg</div><div class="ttdef"><b>Definition:</b> <a href="control__mod_8_f90_source.html#l00081">control_mod.F90:81</a></div></div>
<div class="ttc" id="anamespacedimensions__mod_html"><div class="ttname"><a href="namespacedimensions__mod.html">dimensions_mod</a></div><div class="ttdef"><b>Definition:</b> <a href="dimensions__mod_8_f90_source.html#l00005">dimensions_mod.F90:5</a></div></div>
<div class="ttc" id="anamespacedimensions__mod_html_a0070848a40ac48379601d9a8a183c83b"><div class="ttname"><a href="namespacedimensions__mod.html#a0070848a40ac48379601d9a8a183c83b">dimensions_mod::qsize</a></div><div class="ttdeci">integer, public qsize</div><div class="ttdef"><b>Definition:</b> <a href="dimensions__mod_8_f90_source.html#l00026">dimensions_mod.F90:26</a></div></div>
<div class="ttc" id="anamespacedimensions__mod_html_a311b48352dde44bfd8b73213bfc94689"><div class="ttname"><a href="namespacedimensions__mod.html#a311b48352dde44bfd8b73213bfc94689">dimensions_mod::nlevp</a></div><div class="ttdeci">integer, parameter, public nlevp</div><div class="ttdef"><b>Definition:</b> <a href="dimensions__mod_8_f90_source.html#l00030">dimensions_mod.F90:30</a></div></div>
<div class="ttc" id="anamespacedimensions__mod_html_a6baa218e1683465acc4f37fcea8e30d5"><div class="ttname"><a href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">dimensions_mod::nlev</a></div><div class="ttdeci">integer, parameter, public nlev</div><div class="ttdef"><b>Definition:</b> <a href="dimensions__mod_8_f90_source.html#l00029">dimensions_mod.F90:29</a></div></div>
<div class="ttc" id="anamespacedimensions__mod_html_a7da46639f2907a58fa84db9c4c4401d3"><div class="ttname"><a href="namespacedimensions__mod.html#a7da46639f2907a58fa84db9c4c4401d3">dimensions_mod::npsq</a></div><div class="ttdeci">integer, parameter, public npsq</div><div class="ttdef"><b>Definition:</b> <a href="dimensions__mod_8_f90_source.html#l00028">dimensions_mod.F90:28</a></div></div>
<div class="ttc" id="anamespacedimensions__mod_html_a8648e26ae0e474ccf69d32a8148520c9"><div class="ttname"><a href="namespacedimensions__mod.html#a8648e26ae0e474ccf69d32a8148520c9">dimensions_mod::np</a></div><div class="ttdeci">integer, parameter, public np</div><div class="ttdef"><b>Definition:</b> <a href="dimensions__mod_8_f90_source.html#l00023">dimensions_mod.F90:23</a></div></div>
<div class="ttc" id="anamespacehybvcoord__mod_html"><div class="ttname"><a href="namespacehybvcoord__mod.html">hybvcoord_mod</a></div><div class="ttdef"><b>Definition:</b> <a href="hybvcoord__mod_8_f90_source.html#l00005">hybvcoord_mod.F90:5</a></div></div>
<div class="ttc" id="anamespacekinds_html"><div class="ttname"><a href="namespacekinds.html">kinds</a></div><div class="ttdef"><b>Definition:</b> <a href="kinds_8_f90_source.html#l00005">kinds.F90:5</a></div></div>
<div class="ttc" id="anamespacekinds_html_a3df43a1a47df308ae70f8f8e98d9337c"><div class="ttname"><a href="namespacekinds.html#a3df43a1a47df308ae70f8f8e98d9337c">kinds::int_kind</a></div><div class="ttdeci">integer(kind=4), parameter, public int_kind</div><div class="ttdef"><b>Definition:</b> <a href="kinds_8_f90_source.html#l00027">kinds.F90:27</a></div></div>
<div class="ttc" id="anamespacekinds_html_abddc5e60584151b4d48b02e6436330f3"><div class="ttname"><a href="namespacekinds.html#abddc5e60584151b4d48b02e6436330f3">kinds::real_kind</a></div><div class="ttdeci">integer(kind=4), parameter, public real_kind</div><div class="ttdef"><b>Definition:</b> <a href="kinds_8_f90_source.html#l00027">kinds.F90:27</a></div></div>
<div class="ttc" id="anamespaceparallel__mod_html"><div class="ttname"><a href="namespaceparallel__mod.html">parallel_mod</a></div><div class="ttdef"><b>Definition:</b> <a href="parallel__mod_8_f90_source.html#l00004">parallel_mod.F90:4</a></div></div>
<div class="ttc" id="anamespaceparallel__mod_html_a00f76482d3b7bb15da165475c828f466"><div class="ttname"><a href="namespaceparallel__mod.html#a00f76482d3b7bb15da165475c828f466">parallel_mod::abortmp</a></div><div class="ttdeci">subroutine, public abortmp(string)</div><div class="ttdef"><b>Definition:</b> <a href="parallel__mod_8_f90_source.html#l00293">parallel_mod.F90:294</a></div></div>
<div class="ttc" id="anamespacevertremap__base_html"><div class="ttname"><a href="namespacevertremap__base.html">vertremap_base</a></div><div class="ttdef"><b>Definition:</b> <a href="vertremap__base_8_f90_source.html#l00018">vertremap_base.F90:18</a></div></div>
<div class="ttc" id="anamespacevertremap__base_html_a18cc0d3392ace9aa5e0dc0894122dcfd"><div class="ttname"><a href="namespacevertremap__base.html#a18cc0d3392ace9aa5e0dc0894122dcfd">vertremap_base::remap1_nofilter</a></div><div class="ttdeci">subroutine remap1_nofilter(Qdp, nx, qsize, dp1, dp2)</div><div class="ttdef"><b>Definition:</b> <a href="vertremap__base_8_f90_source.html#l00361">vertremap_base.F90:362</a></div></div>
<div class="ttc" id="anamespacevertremap__base_html_a273480ce56e7f957d8110149f9161579"><div class="ttname"><a href="namespacevertremap__base.html#a273480ce56e7f957d8110149f9161579">vertremap_base::compute_ppm</a></div><div class="ttdeci">real(kind=real_kind) function, dimension(0:2, nlev) compute_ppm(a, dx)</div><div class="ttdef"><b>Definition:</b> <a href="vertremap__base_8_f90_source.html#l00683">vertremap_base.F90:684</a></div></div>
<div class="ttc" id="anamespacevertremap__base_html_a810cc5eb21b6972ada382e2bf6c16c1e"><div class="ttname"><a href="namespacevertremap__base.html#a810cc5eb21b6972ada382e2bf6c16c1e">vertremap_base::binary_search</a></div><div class="ttdeci">subroutine binary_search(pio, pivot, k)</div><div class="ttdef"><b>Definition:</b> <a href="vertremap__base_8_f90_source.html#l00757">vertremap_base.F90:758</a></div></div>
<div class="ttc" id="anamespacevertremap__base_html_a81786cc73156c6c4062715272974bef3"><div class="ttname"><a href="namespacevertremap__base.html#a81786cc73156c6c4062715272974bef3">vertremap_base::integrate_parabola</a></div><div class="ttdeci">real(kind=real_kind) function integrate_parabola(a, x1, x2)</div><div class="ttdef"><b>Definition:</b> <a href="vertremap__base_8_f90_source.html#l00743">vertremap_base.F90:744</a></div></div>
<div class="ttc" id="anamespacevertremap__base_html_a8a8647d7c357c21fa845bf0939128b45"><div class="ttname"><a href="namespacevertremap__base.html#a8a8647d7c357c21fa845bf0939128b45">vertremap_base::linextrap</a></div><div class="ttdeci">subroutine linextrap(dx1, dx2, dx3, dx4, y1, y2, y3, y4, lo, hi)</div><div class="ttdef"><b>Definition:</b> <a href="vertremap__base_8_f90_source.html#l00781">vertremap_base.F90:782</a></div></div>
<div class="ttc" id="anamespacevertremap__base_html_a9d7e68ad35317ebdb785fcd1a72fc7de"><div class="ttname"><a href="namespacevertremap__base.html#a9d7e68ad35317ebdb785fcd1a72fc7de">vertremap_base::remap_calc_grids</a></div><div class="ttdeci">subroutine remap_calc_grids(hvcoord, ps, dt, eta_dot_dpdn, p_lag, p_ref, dp_lag, dp_ref)</div><div class="ttdef"><b>Definition:</b> <a href="vertremap__base_8_f90_source.html#l00050">vertremap_base.F90:51</a></div></div>
<div class="ttc" id="anamespacevertremap__base_html_ab750bd38c31ca69aae4a0ad6c0f9f673"><div class="ttname"><a href="namespacevertremap__base.html#ab750bd38c31ca69aae4a0ad6c0f9f673">vertremap_base::compute_ppm_grids</a></div><div class="ttdeci">real(kind=real_kind) function, dimension(10, 0:nlev+1) compute_ppm_grids(dx)</div><div class="ttdef"><b>Definition:</b> <a href="vertremap__base_8_f90_source.html#l00652">vertremap_base.F90:653</a></div></div>
<div class="ttc" id="anamespacevertremap__base_html_adb17ab316da43ce978d5e856fb85b132"><div class="ttname"><a href="namespacevertremap__base.html#adb17ab316da43ce978d5e856fb85b132">vertremap_base::remap_q_ppm</a></div><div class="ttdeci">subroutine remap_q_ppm(Qdp, nx, qsize, dp1, dp2)</div><div class="ttdef"><b>Definition:</b> <a href="vertremap__base_8_f90_source.html#l00517">vertremap_base.F90:518</a></div></div>
<div class="ttc" id="anamespacevertremap__base_html_af3d970dd3d2368cb76531117cc4aacc4"><div class="ttname"><a href="namespacevertremap__base.html#af3d970dd3d2368cb76531117cc4aacc4">vertremap_base::remap1</a></div><div class="ttdeci">subroutine remap1(Qdp, nx, qsize, dp1, dp2)</div><div class="ttdef"><b>Definition:</b> <a href="vertremap__base_8_f90_source.html#l00078">vertremap_base.F90:79</a></div></div>
<div class="ttc" id="astructhybvcoord__mod_1_1hvcoord__t_html"><div class="ttname"><a href="structhybvcoord__mod_1_1hvcoord__t.html">hybvcoord_mod::hvcoord_t</a></div><div class="ttdef"><b>Definition:</b> <a href="hybvcoord__mod_8_f90_source.html#l00019">hybvcoord_mod.F90:19</a></div></div>
<div class="ttc" id="astructparallel__mod_1_1parallel__t_html"><div class="ttname"><a href="structparallel__mod_1_1parallel__t.html">parallel_mod::parallel_t</a></div><div class="ttdef"><b>Definition:</b> <a href="parallel__mod_8_f90_source.html#l00050">parallel_mod.F90:50</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_0b9b079b26fcc9f7494e277d37e7b67d.html">share</a></li><li class="navelem"><a class="el" href="vertremap__base_8_f90.html">vertremap_base.F90</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
