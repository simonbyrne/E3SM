<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Homme: src/theta-l_kokkos/cxx/DirkFunctorImpl.hpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Homme
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_dirk_functor_impl_8hpp_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">DirkFunctorImpl.hpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_dirk_functor_impl_8hpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/********************************************************************************</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * HOMMEXX 1.0: Copyright of Sandia Corporation</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * This software is released under the BSD license</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * See the file &#39;COPYRIGHT&#39; in the HOMMEXX/src/share/cxx directory</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *******************************************************************************/</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; </div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#ifndef HOMMEXX_DIRK_FUNCTOR_IMPL_HPP</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#define HOMMEXX_DIRK_FUNCTOR_IMPL_HPP</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160; </div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_types_8hpp.html">Types.hpp</a>&quot;</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_equation_of_state_8hpp.html">EquationOfState.hpp</a>&quot;</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_functors_buffers_manager_8hpp.html">FunctorsBuffersManager.hpp</a>&quot;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_elements_8hpp.html">Elements.hpp</a>&quot;</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_hybrid_v_coord_8hpp.html">HybridVCoord.hpp</a>&quot;</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_kernel_variables_8hpp.html">KernelVariables.hpp</a>&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_physical_constants_8hpp.html">PhysicalConstants.hpp</a>&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_element_ops_8hpp.html">ElementOps.hpp</a>&quot;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="profiling_8hpp.html">profiling.hpp</a>&quot;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_error_defs_8hpp.html">ErrorDefs.hpp</a>&quot;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="scream__tridiag_8hpp.html">utilities/scream_tridiag.hpp</a>&quot;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160; </div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &lt;cassert&gt;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160; </div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespace_homme.html">Homme</a> {</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160; </div>
<div class="line"><a name="l00026"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html">   26</a></span>&#160;<span class="keyword">struct </span><a class="code" href="struct_homme_1_1_dirk_functor_impl.html">DirkFunctorImpl</a> {</div>
<div class="line"><a name="l00027"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">   27</a></span>&#160;  enum : <span class="keywordtype">int</span> { <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> = VECTOR_SIZE };</div>
<div class="line"><a name="l00028"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">   28</a></span>&#160;  enum : <span class="keywordtype">int</span> { <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a> = NP*NP };</div>
<div class="line"><a name="l00029"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a69c849c45658f79de0fb94c2468ebf61a8776c8564e68e9e396ebc68e4f746370">   29</a></span>&#160;  enum : <span class="keywordtype">int</span> { <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a69c849c45658f79de0fb94c2468ebf61a8776c8564e68e9e396ebc68e4f746370">npack</a> = (<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a> + <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> - 1)/<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> };</div>
<div class="line"><a name="l00030"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a1361916e03f2069e123251d70f83f928a84580cb970358855cfa71d009189ecbb">   30</a></span>&#160;  enum : <span class="keywordtype">int</span> { <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1361916e03f2069e123251d70f83f928a84580cb970358855cfa71d009189ecbb">max_num_lev_pack</a> = NUM_LEV_P };</div>
<div class="line"><a name="l00031"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#ae9ad1a5a92392bc26952e613bab3ce51a7985952861706100aa02c53882dc99ba">   31</a></span>&#160;  enum : <span class="keywordtype">int</span> { <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae9ad1a5a92392bc26952e613bab3ce51a7985952861706100aa02c53882dc99ba">num_lev_aligned</a> = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1361916e03f2069e123251d70f83f928a84580cb970358855cfa71d009189ecbb">max_num_lev_pack</a>*<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> };</div>
<div class="line"><a name="l00032"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a452f94a8328ea08acda34ca006e04865a8297a59ae2729df8b63a96a014a2df95">   32</a></span>&#160;  enum : <span class="keywordtype">int</span> { <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a452f94a8328ea08acda34ca006e04865a8297a59ae2729df8b63a96a014a2df95">num_phys_lev</a> = NUM_PHYSICAL_LEV };</div>
<div class="line"><a name="l00033"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a1f9bf50bece3e8e9f103b58d708bf1b2ae5f722bf3fa63e41dd5710ba470d70f8">   33</a></span>&#160;  enum : <span class="keywordtype">int</span> { <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1f9bf50bece3e8e9f103b58d708bf1b2ae5f722bf3fa63e41dd5710ba470d70f8">num_work</a> = 12 };</div>
<div class="line"><a name="l00034"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#aac275931d841f7f797dfe8d17d8804faa6a5fe9bdf209c105b47e43d46109c2d3">   34</a></span>&#160;  enum : <span class="keywordtype">bool</span> { <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#aac275931d841f7f797dfe8d17d8804faa6a5fe9bdf209c105b47e43d46109c2d3">calc_initial_guess_in_newton_kernel</a> = <span class="keyword">false</span> };</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160; </div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;  enum : <span class="keywordtype">int</span> {</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#ifdef HOMMEXX_BFB_TESTING</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae764021a76b604cb4d3a8a890f3c1f33a968488ac9452fe91a8c32c4308a55404">default_bfb_solver</a> = <span class="keyword">true</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae764021a76b604cb4d3a8a890f3c1f33a968488ac9452fe91a8c32c4308a55404">default_bfb_solver</a> = <span class="keyword">false</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00042"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#ae764021a76b604cb4d3a8a890f3c1f33a968488ac9452fe91a8c32c4308a55404">   42</a></span>&#160;  };</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160; </div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  static_assert(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae9ad1a5a92392bc26952e613bab3ce51a7985952861706100aa02c53882dc99ba">num_lev_aligned</a> &gt;= 3,</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;                <span class="stringliteral">&quot;We use wrk(0:2,:) and so need num_lev_aligned &gt;= 3&quot;</span>);</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160; </div>
<div class="line"><a name="l00047"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a1ec2e98954a9fd215a4bddfcad45ad8d">   47</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1ec2e98954a9fd215a4bddfcad45ad8d">TeamPolicy</a> = Kokkos::TeamPolicy&lt;ExecSpace&gt;;</div>
<div class="line"><a name="l00048"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a25ccb494d5f63dc7d219495bcba074cf">   48</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a25ccb494d5f63dc7d219495bcba074cf">MT</a> = <span class="keyword">typename</span> TeamPolicy::member_type;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160; </div>
<div class="line"><a name="l00050"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a9af6e752f61b639e7546ef82462761b3">   50</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9af6e752f61b639e7546ef82462761b3">Work</a></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    = Kokkos::View&lt;<a class="code" href="class_kokkos_kernels_1_1_batched_1_1_experimental_1_1_vector.html">Scalar</a>*[<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1f9bf50bece3e8e9f103b58d708bf1b2ae5f722bf3fa63e41dd5710ba470d70f8">num_work</a>][<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae9ad1a5a92392bc26952e613bab3ce51a7985952861706100aa02c53882dc99ba">num_lev_aligned</a>][<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a69c849c45658f79de0fb94c2468ebf61a8776c8564e68e9e396ebc68e4f746370">npack</a>],</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;                   Kokkos::LayoutRight, <a class="code" href="namespace_homme.html#a0f0e1a7897b0895773148728d6a74cb1">ExecSpace</a>&gt;;</div>
<div class="line"><a name="l00053"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">   53</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    = Kokkos::View&lt;<a class="code" href="class_kokkos_kernels_1_1_batched_1_1_experimental_1_1_vector.html">Scalar</a>           [<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae9ad1a5a92392bc26952e613bab3ce51a7985952861706100aa02c53882dc99ba">num_lev_aligned</a>][<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a69c849c45658f79de0fb94c2468ebf61a8776c8564e68e9e396ebc68e4f746370">npack</a>],</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;                   Kokkos::LayoutRight, <a class="code" href="namespace_homme.html#a0f0e1a7897b0895773148728d6a74cb1">ExecSpace</a>,</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;                   Kokkos::MemoryTraits&lt;Kokkos::Unmanaged&gt; &gt;;</div>
<div class="line"><a name="l00057"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#acc71b9c82c12f01dcbe5b35eb7062030">   57</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#acc71b9c82c12f01dcbe5b35eb7062030">ConstWorkSlot</a></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    = Kokkos::View&lt;<span class="keyword">const</span> <a class="code" href="class_kokkos_kernels_1_1_batched_1_1_experimental_1_1_vector.html">Scalar</a>     [<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae9ad1a5a92392bc26952e613bab3ce51a7985952861706100aa02c53882dc99ba">num_lev_aligned</a>][<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a69c849c45658f79de0fb94c2468ebf61a8776c8564e68e9e396ebc68e4f746370">npack</a>],</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;                   Kokkos::LayoutRight, <a class="code" href="namespace_homme.html#a0f0e1a7897b0895773148728d6a74cb1">ExecSpace</a>,</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;                   Kokkos::MemoryTraits&lt;Kokkos::Unmanaged&gt; &gt;;</div>
<div class="line"><a name="l00061"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a6e396d75a11df2ad21f22acda475afb7">   61</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a6e396d75a11df2ad21f22acda475afb7">LinearSystem</a></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    = Kokkos::View&lt;<a class="code" href="class_kokkos_kernels_1_1_batched_1_1_experimental_1_1_vector.html">Scalar</a>*[4][<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a452f94a8328ea08acda34ca006e04865a8297a59ae2729df8b63a96a014a2df95">num_phys_lev</a>][<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a69c849c45658f79de0fb94c2468ebf61a8776c8564e68e9e396ebc68e4f746370">npack</a>],</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;                   Kokkos::LayoutRight, <a class="code" href="namespace_homme.html#a0f0e1a7897b0895773148728d6a74cb1">ExecSpace</a>&gt;;</div>
<div class="line"><a name="l00064"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a63b6c5ff55d179bde23f77243e66314c">   64</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a63b6c5ff55d179bde23f77243e66314c">LinearSystemSlot</a></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    = Kokkos::View&lt;<a class="code" href="class_kokkos_kernels_1_1_batched_1_1_experimental_1_1_vector.html">Scalar</a>    [<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a452f94a8328ea08acda34ca006e04865a8297a59ae2729df8b63a96a014a2df95">num_phys_lev</a>][<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a69c849c45658f79de0fb94c2468ebf61a8776c8564e68e9e396ebc68e4f746370">npack</a>],</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;                   Kokkos::LayoutRight, <a class="code" href="namespace_homme.html#a0f0e1a7897b0895773148728d6a74cb1">ExecSpace</a>,</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;                   Kokkos::MemoryTraits&lt;Kokkos::Unmanaged&gt; &gt;;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160; </div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  KOKKOS_INLINE_FUNCTION</div>
<div class="line"><a name="l00070"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">   70</a></span>&#160;  <span class="keyword">static</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9af6e752f61b639e7546ef82462761b3">Work</a>&amp; w, <span class="keyword">const</span> <span class="keywordtype">int</span>&amp; wi, <span class="keyword">const</span> <span class="keywordtype">int</span>&amp; si) {</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <span class="keyword">using</span> <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">Kokkos::subview</a>;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="keyword">using</span> Kokkos::ALL;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a> = ALL();</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(w, wi, si, <a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>, <a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>);</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  }</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160; </div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  KOKKOS_INLINE_FUNCTION</div>
<div class="line"><a name="l00078"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a4c85036926e6c2f555f24f565bb179be">   78</a></span>&#160;  <span class="keyword">static</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a63b6c5ff55d179bde23f77243e66314c">LinearSystemSlot</a> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4c85036926e6c2f555f24f565bb179be">get_ls_slot</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a6e396d75a11df2ad21f22acda475afb7">LinearSystem</a>&amp; w, <span class="keyword">const</span> <span class="keywordtype">int</span>&amp; wi,</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;                                       <span class="keyword">const</span> <span class="keywordtype">int</span>&amp; si) {</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="keyword">using</span> <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">Kokkos::subview</a>;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="keyword">using</span> Kokkos::ALL;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a> = ALL();</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(w, wi, si, <a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>, <a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>);</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  }</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160; </div>
<div class="line"><a name="l00086"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a4d29c2912f5014c0a878f48ad8268624">   86</a></span>&#160;  <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9af6e752f61b639e7546ef82462761b3">Work</a> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4d29c2912f5014c0a878f48ad8268624">m_work</a>;</div>
<div class="line"><a name="l00087"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a452a30294bda364b6d58fb319d855e06">   87</a></span>&#160;  <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a6e396d75a11df2ad21f22acda475afb7">LinearSystem</a> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a452a30294bda364b6d58fb319d855e06">m_ls</a>;</div>
<div class="line"><a name="l00088"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#ae8678dd7d4c0472d9c376710a5bfe54d">   88</a></span>&#160;  <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1ec2e98954a9fd215a4bddfcad45ad8d">TeamPolicy</a> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae87d36a8fd8bd92c1b960f8896c626d6">m_policy</a>, <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae8678dd7d4c0472d9c376710a5bfe54d">m_ig_policy</a>;</div>
<div class="line"><a name="l00089"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a213ee372718dc93f3d4fadf47574cdab">   89</a></span>&#160;  <a class="code" href="class_homme_1_1_team_utils.html">TeamUtils&lt;ExecSpace&gt;</a> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a213ee372718dc93f3d4fadf47574cdab">m_tu</a>, <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a30b3cfd07066fd2adcfdbde8b05b09fb">m_tu_ig</a>;</div>
<div class="line"><a name="l00090"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#af2208bbe9fadd70135385d703020814d">   90</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#af2208bbe9fadd70135385d703020814d">nslot</a>;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160; </div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  KOKKOS_INLINE_FUNCTION</div>
<div class="line"><a name="l00093"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a756490fb7e2d1d9594c0354c5ab45784">   93</a></span>&#160;  <span class="keywordtype">size_t</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a756490fb7e2d1d9594c0354c5ab45784">shmem_size</a> (<span class="keyword">const</span> <span class="keywordtype">int</span> team_size)<span class="keyword"> const </span>{</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="struct_homme_1_1_kernel_variables.html#aed04848b4565ee447b2d9e5e64f4ba58">KernelVariables::shmem_size</a>(team_size);</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  }</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160; </div>
<div class="line"><a name="l00097"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#abd9c140e611e21fbaffb60a354828862">   97</a></span>&#160;  <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abd9c140e611e21fbaffb60a354828862">DirkFunctorImpl</a> (<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a64817c8f3506c463c896d202d237025e">nelem</a>)</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    : <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae87d36a8fd8bd92c1b960f8896c626d6">m_policy</a>(1,1,1), <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae8678dd7d4c0472d9c376710a5bfe54d">m_ig_policy</a>(1,1,1), <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a213ee372718dc93f3d4fadf47574cdab">m_tu</a>(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae87d36a8fd8bd92c1b960f8896c626d6">m_policy</a>), <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a30b3cfd07066fd2adcfdbde8b05b09fb">m_tu_ig</a>(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae8678dd7d4c0472d9c376710a5bfe54d">m_ig_policy</a>) <span class="comment">// throwaway settings</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  {</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a482a596f608fa186f224ff826fabf4af">init</a>(<a class="code" href="namespacedimensions__mod.html#a64817c8f3506c463c896d202d237025e">nelem</a>);</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  }</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160; </div>
<div class="line"><a name="l00103"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a482a596f608fa186f224ff826fabf4af">  103</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a482a596f608fa186f224ff826fabf4af">init</a> (<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a64817c8f3506c463c896d202d237025e">nelem</a>) {</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="struct_homme_1_1_on_gpu.html">OnGpu&lt;ExecSpace&gt;::value</a>) {</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;      <a class="code" href="struct_homme_1_1_thread_preferences.html">ThreadPreferences</a> tp;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;      tp.<a class="code" href="struct_homme_1_1_thread_preferences.html#a0795fa24c05258def544b18e0c32bd8c">max_threads_usable</a> = NUM_PHYSICAL_LEV;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;      tp.<a class="code" href="struct_homme_1_1_thread_preferences.html#a9765cdd2b5e5c1f5a949e891930bbfae">max_vectors_usable</a> = NP*NP;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;      tp.<a class="code" href="struct_homme_1_1_thread_preferences.html#ac95711d45065769156632a039ccd4ddf">prefer_threads</a> = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;      tp.<a class="code" href="struct_homme_1_1_thread_preferences.html#a29fca994cc460c1d4b4f2bad88cb80a2">prefer_larger_team</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> p = <a class="code" href="struct_homme_1_1_default_threads_distribution.html#a76d4a9f4326d5f0c392a84725fa919bb">DefaultThreadsDistribution&lt;ExecSpace&gt;</a></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<a class="code" href="struct_homme_1_1_default_threads_distribution.html#a76d4a9f4326d5f0c392a84725fa919bb">        ::team_num_threads_vectors</a>(<a class="code" href="namespacedimensions__mod.html#a64817c8f3506c463c896d202d237025e">nelem</a>, tp);</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        nhwthr = p.first*p.second,</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        nvec = <a class="code" href="namespacecedr_1_1impl.html#afaf106747d577e9c3dc9eb35a735b8b1">std::min</a>(NP*NP, nhwthr),</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        nthr = nhwthr/nvec;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae87d36a8fd8bd92c1b960f8896c626d6">m_policy</a> = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1ec2e98954a9fd215a4bddfcad45ad8d">TeamPolicy</a>(<a class="code" href="namespacedimensions__mod.html#a64817c8f3506c463c896d202d237025e">nelem</a>, nthr, nvec);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;      <a class="code" href="struct_homme_1_1_thread_preferences.html">ThreadPreferences</a> tp;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;      tp.<a class="code" href="struct_homme_1_1_thread_preferences.html#a0795fa24c05258def544b18e0c32bd8c">max_threads_usable</a> = NUM_PHYSICAL_LEV;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;      tp.<a class="code" href="struct_homme_1_1_thread_preferences.html#a9765cdd2b5e5c1f5a949e891930bbfae">max_vectors_usable</a> = 1;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;      tp.<a class="code" href="struct_homme_1_1_thread_preferences.html#ac95711d45065769156632a039ccd4ddf">prefer_threads</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> p = <a class="code" href="struct_homme_1_1_default_threads_distribution.html#a76d4a9f4326d5f0c392a84725fa919bb">DefaultThreadsDistribution&lt;ExecSpace&gt;</a></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<a class="code" href="struct_homme_1_1_default_threads_distribution.html#a76d4a9f4326d5f0c392a84725fa919bb">        ::team_num_threads_vectors</a>(<a class="code" href="namespacedimensions__mod.html#a64817c8f3506c463c896d202d237025e">nelem</a>, tp);</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae87d36a8fd8bd92c1b960f8896c626d6">m_policy</a> = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1ec2e98954a9fd215a4bddfcad45ad8d">TeamPolicy</a>(<a class="code" href="namespacedimensions__mod.html#a64817c8f3506c463c896d202d237025e">nelem</a>, p.first, 1);</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    }</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a213ee372718dc93f3d4fadf47574cdab">m_tu</a> = <a class="code" href="class_homme_1_1_team_utils.html">TeamUtils&lt;ExecSpace&gt;</a>(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae87d36a8fd8bd92c1b960f8896c626d6">m_policy</a>);</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#af2208bbe9fadd70135385d703020814d">nslot</a> = <a class="code" href="namespacecedr_1_1impl.html#afaf106747d577e9c3dc9eb35a735b8b1">std::min</a>(<a class="code" href="namespacedimensions__mod.html#a64817c8f3506c463c896d202d237025e">nelem</a>, <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a213ee372718dc93f3d4fadf47574cdab">m_tu</a>.<a class="code" href="class_homme_1_1___team_utils_common_base.html#abee222dbd07f3305af7b96e25dba9c75">get_num_ws_slots</a>());</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae8678dd7d4c0472d9c376710a5bfe54d">m_ig_policy</a> = Homme::get_default_team_policy&lt;ExecSpace&gt;(<a class="code" href="namespacedimensions__mod.html#a64817c8f3506c463c896d202d237025e">nelem</a>);</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a30b3cfd07066fd2adcfdbde8b05b09fb">m_tu_ig</a> = <a class="code" href="class_homme_1_1_team_utils.html">TeamUtils&lt;ExecSpace&gt;</a>(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae8678dd7d4c0472d9c376710a5bfe54d">m_ig_policy</a>);</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  }</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160; </div>
<div class="line"><a name="l00132"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#aaa0cba0d780f6f82ef24f5f66efe2339">  132</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#aaa0cba0d780f6f82ef24f5f66efe2339">requested_buffer_size</a> ()<span class="keyword"> const </span>{</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <span class="comment">// FunctorsBuffersManager wants the size in terms of sizeof(Real).</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    <span class="keywordflow">return</span> (Work::shmem_size(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#af2208bbe9fadd70135385d703020814d">nslot</a>) + LinearSystem::shmem_size(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#af2208bbe9fadd70135385d703020814d">nslot</a>))/<span class="keyword">sizeof</span>(<a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a>);</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  }</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160; </div>
<div class="line"><a name="l00137"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#ab84a51a898552b520929b580aec455f1">  137</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ab84a51a898552b520929b580aec455f1">init_buffers</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_functors_buffers_manager.html">FunctorsBuffersManager</a>&amp; fbm) {</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <a class="code" href="class_kokkos_kernels_1_1_batched_1_1_experimental_1_1_vector.html">Scalar</a>* mem = <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="class_kokkos_kernels_1_1_batched_1_1_experimental_1_1_vector.html">Scalar</a>*<span class="keyword">&gt;</span>(fbm.<a class="code" href="struct_homme_1_1_functors_buffers_manager.html#ad255e5d3e2743ce109d316c596f30e4d">get_memory</a>());</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4d29c2912f5014c0a878f48ad8268624">m_work</a> = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9af6e752f61b639e7546ef82462761b3">Work</a>(mem, <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#af2208bbe9fadd70135385d703020814d">nslot</a>);</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    mem += Work::shmem_size(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#af2208bbe9fadd70135385d703020814d">nslot</a>)/<span class="keyword">sizeof</span>(<a class="code" href="namespace_homme.html#a14cb237a09aa2cdfd9095a8d3b048092">Scalar</a>);</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a452a30294bda364b6d58fb319d855e06">m_ls</a> = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a6e396d75a11df2ad21f22acda475afb7">LinearSystem</a>(mem, <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#af2208bbe9fadd70135385d703020814d">nslot</a>);</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  }</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160; </div>
<div class="line"><a name="l00144"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#aacd66adbf0a65ff852dadd75d96c970c">  144</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#aacd66adbf0a65ff852dadd75d96c970c">run</a> (<span class="keywordtype">int</span> nm1, <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> alphadt_nm1, <span class="keywordtype">int</span> n0, <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> alphadt_n0, <span class="keywordtype">int</span> np1, <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> dt2,</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;            <span class="keyword">const</span> <a class="code" href="class_homme_1_1_elements.html">Elements</a>&amp; e, <span class="keyword">const</span> <a class="code" href="class_homme_1_1_hybrid_v_coord.html">HybridVCoord</a>&amp; hvcoord,</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">bool</span> bfb_solver = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae764021a76b604cb4d3a8a890f3c1f33a968488ac9452fe91a8c32c4308a55404">default_bfb_solver</a>) {</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keywordflow">if</span> ( ! <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#aac275931d841f7f797dfe8d17d8804faa6a5fe9bdf209c105b47e43d46109c2d3">calc_initial_guess_in_newton_kernel</a>) {</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a6e1ff184b5d4288c62224ed6c2d6c66a">run_initial_guess</a>(np1, e, hvcoord);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;      Kokkos::fence();</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    }</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160; </div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a553a47e88f1375616594e54814915650">run_newton</a>(nm1, alphadt_nm1, n0, alphadt_n0, np1, dt2, e, hvcoord, bfb_solver);</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    Kokkos::fence();</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  }</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160; </div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;  <span class="comment">// Optimal impl of phi_from_eos for the initial guess. See comments for the</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  <span class="comment">// function phi_from_eos, below, for discussion. This kernel uses standard</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;  <span class="comment">// Hommexx layout and parallelization approaches to compute the scans</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  <span class="comment">// optimally.</span></div>
<div class="line"><a name="l00160"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a6e1ff184b5d4288c62224ed6c2d6c66a">  160</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a6e1ff184b5d4288c62224ed6c2d6c66a">run_initial_guess</a> (<span class="keywordtype">int</span> np1, <span class="keyword">const</span> <a class="code" href="class_homme_1_1_elements.html">Elements</a>&amp; e, <span class="keyword">const</span> <a class="code" href="class_homme_1_1_hybrid_v_coord.html">HybridVCoord</a>&amp; hvcoord) {</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <span class="keyword">using</span> <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">Kokkos::subview</a>;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="keyword">using</span> Kokkos::parallel_for;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160; </div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> e_phis = e.<a class="code" href="class_homme_1_1_elements.html#a26a237a775286be986bc269e18c0d764">m_geometry</a>.<a class="code" href="class_homme_1_1_elements_geometry.html#a245d6743bc0f3d3d6fc41a27d17764f5">m_phis</a>;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> e_vtheta_dp = e.<a class="code" href="class_homme_1_1_elements.html#a45ed484dcba35066f7511ed61d652541">m_state</a>.<a class="code" href="class_homme_1_1_elements_state.html#ac439b933e57d3d4eaea975240f4c7e37">m_vtheta_dp</a>;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> e_dp3d = e.<a class="code" href="class_homme_1_1_elements.html#a45ed484dcba35066f7511ed61d652541">m_state</a>.<a class="code" href="class_homme_1_1_elements_state.html#abaceb199362f44be6f65fad0412aa4f7">m_dp3d</a>;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> e_phinh_i = e.<a class="code" href="class_homme_1_1_elements.html#aaf5acfcae5ba0ed8cb567b564f997baf">m_derived</a>.<a class="code" href="class_homme_1_1_elements_derived_state.html#acbc1911bd13f604d9b5341bf5e4d41b7">m_divdp_proj</a>;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160; </div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <a class="code" href="class_homme_1_1_element_ops.html">ElementOps</a> elem_ops;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    elem_ops.<a class="code" href="class_homme_1_1_element_ops.html#a4a9e0b79f464751ea3e7e638b5477fae">init</a>(hvcoord);</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160; </div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> work = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4d29c2912f5014c0a878f48ad8268624">m_work</a>;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> tu   = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a30b3cfd07066fd2adcfdbde8b05b09fb">m_tu_ig</a>;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160; </div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> toplevel = KOKKOS_LAMBDA (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a25ccb494d5f63dc7d219495bcba074cf">MT</a>&amp; team) {</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;      <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a> kv(team, tu);</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> ie = kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a3191a82ad3209763dfd817720ea68ab5">ie</a>;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160; </div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;      <span class="keyword">const</span> <a class="code" href="namespace_homme.html#ab890b69860872d32c6a3173f53674505">ExecViewUnmanaged&lt;Scalar[NP][NP][NUM_LEV_P]&gt;</a></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        p_i  (<span class="keyword">reinterpret_cast&lt;</span><a class="code" href="class_kokkos_kernels_1_1_batched_1_1_experimental_1_1_vector.html">Scalar</a>*<span class="keyword">&gt;</span>(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>, 0).data())),</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        phi_i(<span class="keyword">reinterpret_cast&lt;</span><a class="code" href="class_kokkos_kernels_1_1_batched_1_1_experimental_1_1_vector.html">Scalar</a>*<span class="keyword">&gt;</span>(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>, 2).data()));</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;      <span class="keyword">const</span> <a class="code" href="namespace_homme.html#ab890b69860872d32c6a3173f53674505">ExecViewUnmanaged&lt;Scalar[NP][NP][NUM_LEV  ]&gt;</a></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        p    (<span class="keyword">reinterpret_cast&lt;</span><a class="code" href="class_kokkos_kernels_1_1_batched_1_1_experimental_1_1_vector.html">Scalar</a>*<span class="keyword">&gt;</span>(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>, 1).data()));</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160; </div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> f = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> idx) {</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">int</span> igp = idx / NP, jgp = idx % NP;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160; </div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> p_i_c = <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">Homme::subview</a>(p_i,igp,jgp);</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> p_c = <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">Homme::subview</a>(p,igp,jgp);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> phi_i_c = <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">Homme::subview</a>(phi_i,igp,jgp);</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160; </div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        elem_ops.<a class="code" href="class_homme_1_1_element_ops.html#aa30951180b2e0480a83418e99faf6374">compute_hydrostatic_p</a>(kv, <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">Homme::subview</a>(e_dp3d,ie,np1,igp,jgp), p_i_c, p_c);</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        <a class="code" href="class_homme_1_1_equation_of_state.html#aa0dc6b8c326b5f6acd07ce25658f652b">EquationOfState::compute_phi_i</a>(kv, e_phis(ie,igp,jgp),</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;                                       <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">Homme::subview</a>(e_vtheta_dp,ie,np1,igp,jgp),</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                                       p_c, phi_i_c);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160; </div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        <span class="comment">// Copy phi_i for use in run_newton. Don&#39;t need nlevp, since that&#39;s</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        <span class="comment">// always phis.</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a> = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>) { e_phinh_i(ie,igp,jgp,<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>) = phi_i_c(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>); };</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        Kokkos::parallel_for(Kokkos::ThreadVectorRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, NUM_LEV), <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a>);</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;      };</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      parallel_for(Kokkos::TeamThreadRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, NP*NP), f);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    };</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    Kokkos::parallel_for(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae8678dd7d4c0472d9c376710a5bfe54d">m_ig_policy</a>, toplevel);</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  }</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160; </div>
<div class="line"><a name="l00207"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a553a47e88f1375616594e54814915650">  207</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a553a47e88f1375616594e54814915650">run_newton</a> (<span class="keywordtype">int</span> nm1, <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> alphadt_nm1, <span class="keywordtype">int</span> n0, <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> alphadt_n0, <span class="keywordtype">int</span> np1, <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> dt2,</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                   <span class="keyword">const</span> <a class="code" href="class_homme_1_1_elements.html">Elements</a>&amp; e, <span class="keyword">const</span> <a class="code" href="class_homme_1_1_hybrid_v_coord.html">HybridVCoord</a>&amp; hvcoord, <span class="keyword">const</span> <span class="keywordtype">bool</span> bfb_solver) {</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="keyword">using</span> <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">Kokkos::subview</a>;</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="keyword">using</span> Kokkos::parallel_for;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a> = Kokkos::ALL();</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160; </div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> grav = <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">PhysicalConstants::g</a>;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> nvec = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a69c849c45658f79de0fb94c2468ebf61a8776c8564e68e9e396ebc68e4f746370">npack</a>;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> maxiter = 20;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="preprocessor">#ifdef HOMMEXX_BFB_TESTING</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="keyword">const</span> <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> deltatol = 1e-6; <span class="comment">// In bfb testing, use coarse tolerance, due to zeroulp calls</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="keyword">const</span> <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> deltatol = 1e-11; <span class="comment">// exit if newton increment &lt; deltatol</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160; </div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> work = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4d29c2912f5014c0a878f48ad8268624">m_work</a>;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> ls = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a452a30294bda364b6d58fb319d855e06">m_ls</a>;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> e_w_i = e.<a class="code" href="class_homme_1_1_elements.html#a45ed484dcba35066f7511ed61d652541">m_state</a>.<a class="code" href="class_homme_1_1_elements_state.html#a28d9e924694607074a3acfe1c9998003">m_w_i</a>;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> e_vtheta_dp = e.<a class="code" href="class_homme_1_1_elements.html#a45ed484dcba35066f7511ed61d652541">m_state</a>.<a class="code" href="class_homme_1_1_elements_state.html#ac439b933e57d3d4eaea975240f4c7e37">m_vtheta_dp</a>;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> e_phinh_i = e.<a class="code" href="class_homme_1_1_elements.html#a45ed484dcba35066f7511ed61d652541">m_state</a>.<a class="code" href="class_homme_1_1_elements_state.html#a8198395c8fab8ed92076e045cefb43e5">m_phinh_i</a>;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> e_dp3d = e.<a class="code" href="class_homme_1_1_elements.html#a45ed484dcba35066f7511ed61d652541">m_state</a>.<a class="code" href="class_homme_1_1_elements_state.html#abaceb199362f44be6f65fad0412aa4f7">m_dp3d</a>;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> e_v = e.<a class="code" href="class_homme_1_1_elements.html#a45ed484dcba35066f7511ed61d652541">m_state</a>.<a class="code" href="class_homme_1_1_elements_state.html#a0a00f14cc800bce90d8e6b9712a053fd">m_v</a>;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> e_phis = e.<a class="code" href="class_homme_1_1_elements.html#a26a237a775286be986bc269e18c0d764">m_geometry</a>.<a class="code" href="class_homme_1_1_elements_geometry.html#a245d6743bc0f3d3d6fc41a27d17764f5">m_phis</a>;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> e_gradphis = e.<a class="code" href="class_homme_1_1_elements.html#a26a237a775286be986bc269e18c0d764">m_geometry</a>.<a class="code" href="class_homme_1_1_elements_geometry.html#a966d0386f61585ab792d357a6e9da7fb">m_gradphis</a>;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> e_initial_guess = e.<a class="code" href="class_homme_1_1_elements.html#aaf5acfcae5ba0ed8cb567b564f997baf">m_derived</a>.<a class="code" href="class_homme_1_1_elements_derived_state.html#acbc1911bd13f604d9b5341bf5e4d41b7">m_divdp_proj</a>;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> hybi = hvcoord.<a class="code" href="class_homme_1_1_hybrid_v_coord.html#acb82e2af73773e56e92ec2323a483ffd">hybrid_bi</a>;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> tu   = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a213ee372718dc93f3d4fadf47574cdab">m_tu</a>;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160; </div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> toplevel = KOKKOS_LAMBDA (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a25ccb494d5f63dc7d219495bcba074cf">MT</a>&amp; team) {</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;      <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a> kv(team, tu);</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> ie = kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a3191a82ad3209763dfd817720ea68ab5">ie</a>;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a> = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a452f94a8328ea08acda34ca006e04865a8297a59ae2729df8b63a96a014a2df95">num_phys_lev</a>;</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160; </div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;      phi_n0    = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>,  0),</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;      phi_np1   = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>,  1),</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;      dphi      = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>,  2),</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;      w_n0      = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>,  3),</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;      w_np1     = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>,  4),</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;      dpnh_dp_i = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>,  5),</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;      gwh_i     = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>,  6),</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;      dphi_n0   = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>,  6), <span class="comment">// reuse gwh_i</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;      vtheta_dp = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>,  7),</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;      dp3d      = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>,  8),</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;      pnh       = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>,  9),</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;      wrk       = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>, 10),</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;      xfull     = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">get_work_slot</a>(work, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>, 11);</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;      dl = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4c85036926e6c2f555f24f565bb179be">get_ls_slot</a>(ls, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>, 0),</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;      d  = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4c85036926e6c2f555f24f565bb179be">get_ls_slot</a>(ls, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>, 1),</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;      du = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4c85036926e6c2f555f24f565bb179be">get_ls_slot</a>(ls, kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">team_idx</a>, 2);</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160; </div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;      <span class="comment">// View of xfull for use in the solver. We want xfull so that we</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;      <span class="comment">// can use the nlevp-1 entry, which we make sure is 0, when convenient.</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a63b6c5ff55d179bde23f77243e66314c">LinearSystemSlot</a> <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a> = <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(xfull, Kokkos::pair&lt;int,int&gt;(0,<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>), <a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>);</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;      xfull(<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>,0)[0] = 0.0;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160; </div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> transpose4 = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> nt, <span class="keyword">const</span> <span class="keywordtype">bool</span> transpose_phi_np1 = <span class="keyword">true</span>) {</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a39a90f678adac5e26c0b4615b096d256">transpose</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1, <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_w_i      ,ie,nt,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>), w_np1    );</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a39a90f678adac5e26c0b4615b096d256">transpose</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>,   <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_vtheta_dp,ie,nt,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>), vtheta_dp);</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a39a90f678adac5e26c0b4615b096d256">transpose</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>,   <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_dp3d     ,ie,nt,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>), dp3d     );</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        <span class="keywordflow">if</span> ( ! transpose_phi_np1) <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a39a90f678adac5e26c0b4615b096d256">transpose</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1, <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_phinh_i  ,ie,nt,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>), phi_np1  );</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;      };</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160; </div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> accum_n0 = [&amp;] (<span class="keyword">const</span> <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> dt3, <span class="keyword">const</span> <span class="keywordtype">int</span> nt) {</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        <span class="comment">// Computing these transposes is inefficient, but doing so lets us use</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        <span class="comment">// the same pnh_and_exner_from_eos as we use elsewhere. This function is</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <span class="comment">// called only in ~1 out of 5 DIRK stage calls, and only outside of the</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        <span class="comment">// Newton iteration. (Also, tbc, transpose and pnh_and_exner_from_eos</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        <span class="comment">// are parallel efficient.)</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        transpose4(nt);</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ad2bb0654a9d028faa8f136f293902a2b">calc_gwphis</a>(kv, <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_dp3d,ie,nt,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>), <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_v,ie,nt,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>),</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                    <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_gradphis,ie,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>), hybi, gwh_i);</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;          dphi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = phi_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>+1,i) - phi_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i);</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        });</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ad42290f30bc15bdcca5d08b09b35b2f5">pnh_and_exner_from_eos</a>(kv, hvcoord, vtheta_dp, dp3d, dphi, pnh, wrk, dpnh_dp_i);</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;          w_n0(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) += dt3*grav*(dpnh_dp_i(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) - 1);</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        });</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;          phi_n0(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = phi_n0(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) + dt3*grav*w_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) - dt3*gwh_i(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i);</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        });</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;      };</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160; </div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;      <span class="comment">// Compute w_n0, phi_n0.</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a39a90f678adac5e26c0b4615b096d256">transpose</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1, <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_phinh_i,ie,np1,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>), phi_n0);</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a39a90f678adac5e26c0b4615b096d256">transpose</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1, <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_w_i    ,ie,np1,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>), w_n0  );</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;      kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;      <span class="comment">// wmax is computed before optional updates to w_n0.</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> wmax = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ab72c4b923177016f64e0db275c5797c7">calc_wmax</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1, nvec, w_n0);</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;      <span class="comment">// Computed only in some cases.</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;      <span class="keywordflow">if</span> (alphadt_n0 != 0) {</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        accum_n0(alphadt_n0, n0);</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;      }</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;      <span class="keywordflow">if</span> (alphadt_nm1 != 0) {</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        assert(nm1 &gt;= 0);</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        accum_n0(alphadt_nm1, nm1);</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;      }</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;      <span class="comment">// Always computed.</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;      transpose4(np1, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ad2bb0654a9d028faa8f136f293902a2b">calc_gwphis</a>(kv, <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_dp3d,ie,np1,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>), <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_v,ie,np1,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>),</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                  <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_gradphis,ie,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>), hybi, gwh_i);</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;      kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) { phi_n0(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) -= dt2*gwh_i(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i); });</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160; </div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;      <span class="comment">// Initial guess for phi_np1.</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#aac275931d841f7f797dfe8d17d8804faa6a5fe9bdf209c105b47e43d46109c2d3">calc_initial_guess_in_newton_kernel</a>) {</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        <span class="comment">// Use hydrostatic phi.</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a0852061e230d0e46651f404401b3e3fe">phi_from_eos</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, hvcoord, <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_phis,ie,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>), vtheta_dp, dp3d, phi_np1);</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;      } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="comment">// Copy initial guess from where run_initial_guess stashed it.</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a39a90f678adac5e26c0b4615b096d256">transpose</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_initial_guess,ie,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>), phi_np1);</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, 1, nvec, [&amp;] (<span class="keywordtype">int</span>, <span class="keywordtype">int</span> i) { <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a261c733c3be6b14ca97ce4d167cebe5d">set_phis</a>(i, <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_phis,ie,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>), phi_np1); });</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;      }</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;      kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) { dphi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = phi_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>+1,i) - phi_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i); });</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;      kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;      <span class="comment">// If any dphi &gt; -g in a column, set it to -g and integrate to get a</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;      <span class="comment">// new initial phi_np1 and w_np1.</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a91451cda2de85e1624b5376c6cae7893">calc_whether_gt_and_set</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, -grav, dphi, wrk);</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;      kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;      <span class="keywordflow">if</span> (wrk(1,0)[0] == 1) {</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1f3aa2f68c73bded6307bf0a63835bd5">scan_dphi</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, wrk, dphi, phi_np1);</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;      }</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160; </div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;      <span class="comment">// Initial guess for w_np1.</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) { w_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = (phi_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) - phi_n0(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i))/(dt2*grav); });</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160; </div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) { dphi_n0(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = phi_n0(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>+1,i) - phi_n0(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i); });</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160; </div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;      <span class="keywordtype">int</span> it = 0;</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;      <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> deltaerr;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;      <span class="keywordflow">for</span> (; it &lt; maxiter; ++it) { <span class="comment">// Newton iteration</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ad42290f30bc15bdcca5d08b09b35b2f5">pnh_and_exner_from_eos</a>(kv, hvcoord, vtheta_dp, dp3d, dphi, pnh, wrk, dpnh_dp_i);</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;          <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = -(w_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) - (w_n0(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) + grav*dt2*(dpnh_dp_i(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) - 1))); <span class="comment">// -residual</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;        });</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160; </div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ac2a8cf41d71c13c423ab248c1f9426bf">calc_jacobian</a>(kv, dt2, dp3d, dphi, pnh, dl, d, du);</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        <span class="keywordflow">if</span> (bfb_solver) <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ab5831cc2145e27a1bdc82cf2dbc94eaf">solvebfb</a>(kv, dl, d, du, <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>); <span class="keywordflow">else</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abc314dac1110aeebebd6d1ca8fa7ee8a">solve</a>(kv, dl, d, du, <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>);</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160; </div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, 1, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) { wrk(2,i) = 1; });</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> nsafe = 0; nsafe &lt; 2; ++nsafe) {</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;          <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>-1, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;            dphi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = dphi_n0(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) + dt2*grav*(         (w_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>+1,i) - w_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)) +</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                                                 wrk(2,i)*(    <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>+1,i) -     <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)));</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;          });</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;          <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, 1, nvec, [&amp;] (<span class="keywordtype">int</span>, <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> = <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>-1;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;            dphi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = dphi_n0(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) - dt2*grav*(w_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) + wrk(2,i)*<a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i));</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;          });</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;          kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;          <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a81b5136d79fe85b544708cab3a1ca1a2">calc_whether_ge</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, 0, dphi, wrk);</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;          kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;          <span class="keywordflow">if</span> (wrk(1,0)[0] == 0) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;          <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a3adfd04dd5251eaa7542e40bd80cee04">calc_step_size</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, grav, dt2, dphi_n0, w_np1, <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>, wrk);</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;          kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        }</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160; </div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) { w_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) += wrk(2,i)*<a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i); });</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160; </div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae7960c37222103c9425822489f3a0ef1">exit_on_step</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, wmax, deltatol, <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>, deltaerr)) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;      } <span class="comment">// Newton iteration</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;      kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160; </div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;      <span class="keywordflow">if</span> (it&gt;=maxiter) {</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        printf (<span class="stringliteral">&quot;[DIRK] WARNING! Newton reached max iteration count, with deltaerr = %3.17f\n&quot;</span>,deltaerr);</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;      }</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160; </div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;      <span class="comment">// Update phi_np1.</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) { phi_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = phi_n0(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) + dt2*grav*w_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i); });</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160; </div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;      kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a39a90f678adac5e26c0b4615b096d256">transpose</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1, phi_np1, <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_phinh_i,ie,np1,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>));</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a39a90f678adac5e26c0b4615b096d256">transpose</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>+1, w_np1,   <a class="code" href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">subview</a>(e_w_i    ,ie,np1,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>,<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>));</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    };</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160; </div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    Kokkos::parallel_for(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae87d36a8fd8bd92c1b960f8896c626d6">m_policy</a>, toplevel);</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;  }</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160; </div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Fn&gt;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  KOKKOS_INLINE_FUNCTION</div>
<div class="line"><a name="l00402"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">  402</a></span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv, <span class="keyword">const</span> <span class="keywordtype">int</span> klim,</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                       <span class="keyword">const</span> <span class="keywordtype">int</span> ilim, <span class="keyword">const</span> Fn&amp; <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a>) {</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="keyword">using</span> Kokkos::parallel_for;</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="keyword">using</span> Kokkos::TeamThreadRange;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="keyword">using</span> Kokkos::ThreadVectorRange;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160; </div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="struct_homme_1_1_on_gpu.html">OnGpu&lt;ExecSpace&gt;::value</a>) {</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> tr = TeamThreadRange  (kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, klim);</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> vr = ThreadVectorRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, ilim);</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> f = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>) {</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> h = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> i) { <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a>(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i); };</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        parallel_for(vr, h);</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;      };</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;      parallel_for(tr, f);</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>.team_size() == 1) {</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> = 0; <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> &lt; klim; ++<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>)</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; ilim; ++i)</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;          <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a>(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i);</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> tr = TeamThreadRange  (kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, klim);</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> f = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>) {</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; ilim; ++i)</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;          <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a>(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i);</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;      };</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;      parallel_for(tr, f);</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    }</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  }</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160; </div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  <span class="comment">// Format of rest of Hxx -&gt; DIRK Newton iteration format.</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> View&gt;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;  KOKKOS_INLINE_FUNCTION</div>
<div class="line"><a name="l00433"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a39a90f678adac5e26c0b4615b096d256">  433</a></span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a39a90f678adac5e26c0b4615b096d256">transpose</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>,</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                         <span class="keyword">const</span> View&amp; src, <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a>&amp; dst,</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                         <span class="keyword">typename</span> std::enable_if&lt;View::rank == 3&gt;::type* = 0) {</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    assert(src.extent_int(2)*<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> &gt;= <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>);</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    assert(src.extent_int(0) == NP &amp;&amp; src.extent_int(1) == NP);</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> f = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>) {</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;      pk = <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> / <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>,</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;      sk = <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> % <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>;</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a> = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> gk0 = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>*i;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s = 0; s &lt; <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>; ++s) {</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;          <span class="keyword">const</span> <span class="keyword">auto</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;          gk = gk0 + s,</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;          gi = gk / NP,</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;          gj = gk % NP;</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a> % <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> != 0 &amp;&amp; <span class="comment">// try to compile out this conditional when possible</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;              gk &gt;= <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a>) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;          dst(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)[s] = src(gi,gj,pk)[sk];</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;        }</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;      };</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">int</span> n = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a69c849c45658f79de0fb94c2468ebf61a8776c8564e68e9e396ebc68e4f746370">npack</a>;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> p = Kokkos::ThreadVectorRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, n);</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;      Kokkos::parallel_for(p, <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a>);</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    };    </div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    Kokkos::parallel_for(Kokkos::TeamThreadRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>), f);</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  }</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160; </div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;  <span class="comment">// DIRK Newton iteration format -&gt; format of rest of Hxx.</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> View&gt;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  KOKKOS_INLINE_FUNCTION</div>
<div class="line"><a name="l00464"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a3ccb88fe20a348a06bd85094a240598b">  464</a></span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a3ccb88fe20a348a06bd85094a240598b">transpose</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>,</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                         <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a>&amp; src, <span class="keyword">const</span> View&amp; dst,</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                         <span class="keyword">typename</span> std::enable_if&lt;View::rank == 3&gt;::type* = 0) {</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    assert(dst.extent_int(2)*<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> &gt;= <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>);</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    assert(dst.extent_int(0) == NP &amp;&amp; dst.extent_int(1) == NP);</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> f = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> idx) {</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;      gi = idx / NP,</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;      gj = idx % NP,</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;      <a class="code" href="namespacejw.html#a655cdd60136294f8259068e09d1307ff">pi</a> = idx / <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>,</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;      si = idx % <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a> = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> pk) {</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> k0 = pk*<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        <span class="comment">// If there is a remainder at the end, we nonetheless transfer these</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        <span class="comment">// unused data to avoid a conditional and runtime loop limit.</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> sk = 0; sk &lt; <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>; ++sk)</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;          dst(gi,gj,pk)[sk] = src(k0+sk,<a class="code" href="namespacejw.html#a655cdd60136294f8259068e09d1307ff">pi</a>)[si];</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;      };</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> p = Kokkos::ThreadVectorRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, dst.extent_int(2));</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;      Kokkos::parallel_for(p, <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a>);</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    };    </div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    Kokkos::parallel_for(Kokkos::TeamThreadRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, NP*NP), f);</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;  }</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160; </div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;  <span class="comment">// Compute a vertical velocity induced by surface topography:</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;  <span class="comment">//     wh_i = ubar grad phis</span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> R, <span class="keyword">typename</span> Rv, <span class="keyword">typename</span> Rgphis, <span class="keyword">typename</span> Rhybi, <span class="keyword">typename</span> W&gt;</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;  KOKKOS_INLINE_FUNCTION</div>
<div class="line"><a name="l00492"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#ad2bb0654a9d028faa8f136f293902a2b">  492</a></span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ad2bb0654a9d028faa8f136f293902a2b">calc_gwphis</a> (</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv,</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    <span class="comment">// All in arrays are in Hxx format.</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    <span class="keyword">const</span> R&amp; dp3d, <span class="keyword">const</span> Rv&amp; v, <span class="keyword">const</span> Rgphis&amp; gradphis, <span class="keyword">const</span> Rhybi&amp; hybi,</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    <span class="comment">// Out array is in DIRK format. gwh_i(nlevp,:) is not written since it is</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="comment">// not used.</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="keyword">const</span> W&amp; gwh_i,</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a> = NUM_PHYSICAL_LEV)</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;  {</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="keyword">using</span> Kokkos::parallel_for;</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="keyword">using</span> Kokkos::TeamThreadRange;</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="keyword">using</span> Kokkos::ThreadVectorRange;</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160; </div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> n = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a69c849c45658f79de0fb94c2468ebf61a8776c8564e68e9e396ebc68e4f746370">npack</a>;</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> pv = ThreadVectorRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, n);</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160; </div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> f1 = [&amp;] (<span class="keyword">const</span> int) {</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> k0 = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> i) { gwh_i(0,i) = 0; };</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;      parallel_for(pv, k0);</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    };</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    parallel_for(TeamThreadRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, 1), f1);</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160; </div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> f2 = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> km1) {</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;      <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> = km1 + 1,</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;      pk = <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> / <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>,</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;      sk = <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> % <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>,</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;      pkm1 = (<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>-1) / <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>,</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;      skm1 = (<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>-1) % <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a> = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        <a class="code" href="class_kokkos_kernels_1_1_batched_1_1_experimental_1_1_vector.html">Scalar</a> dp3dk, dp3dkm1, v1k, v2k, v1km1, v2km1, gphis1, gphis2;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s = 0; s &lt; <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>; ++s) {</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;          <span class="keyword">const</span> <span class="keyword">auto</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;          idx = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>*i + s,</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;          gi = idx / NP,</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;          gj = idx % NP;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a> % <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> != 0 &amp;&amp; idx &gt;= <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a>) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;          dp3dkm1[s] = dp3d(gi,gj,pkm1)[skm1];</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;          dp3dk  [s] = dp3d(gi,gj,pk  )[sk];</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;          v1km1  [s] = v (0,gi,gj,pkm1)[skm1];</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;          v2km1  [s] = v (1,gi,gj,pkm1)[skm1];</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;          v1k    [s] = v (0,gi,gj,pk  )[sk];</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;          v2k    [s] = v (1,gi,gj,pk  )[sk];</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;          gphis1 [s] = gradphis(0,gi,gj);</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;          gphis2 [s] = gradphis(1,gi,gj);</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        }</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> den = dp3dkm1 + dp3dk;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> v1_i = (dp3dk*v1k + dp3dkm1*v1km1) / den;</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> v2_i = (dp3dk*v2k + dp3dkm1*v2km1) / den;</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        gwh_i(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = (v1_i*gphis1 + v2_i*gphis2)*hybi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>);</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;      };</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;      parallel_for(pv, <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a>);</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    };</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    parallel_for(TeamThreadRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>-1), f2);</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;  }</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160; </div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> R, <span class="keyword">typename</span> W, <span class="keyword">typename</span> Wi&gt;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;  KOKKOS_INLINE_FUNCTION</div>
<div class="line"><a name="l00550"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#ad42290f30bc15bdcca5d08b09b35b2f5">  550</a></span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ad42290f30bc15bdcca5d08b09b35b2f5">pnh_and_exner_from_eos</a> (</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv, <span class="keyword">const</span> <a class="code" href="class_homme_1_1_hybrid_v_coord.html">HybridVCoord</a>&amp; hvcoord,</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    <span class="comment">// All arrays are in DIRK format.</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    <span class="keyword">const</span> R&amp; vtheta_dp, <span class="keyword">const</span> R&amp; dp3d, <span class="keyword">const</span> R&amp; dphi,</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    <span class="comment">// exner is workspace. dpnh_dp_i(nlevp,:) is not computed.</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    <span class="keyword">const</span> W&amp; pnh, <span class="keyword">const</span> W&amp; exner, <span class="keyword">const</span> Wi&amp; dpnh_dp_i,</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a> = NUM_PHYSICAL_LEV)</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;  {</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    <span class="keyword">using</span> Kokkos::parallel_for;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160; </div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> n = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a69c849c45658f79de0fb94c2468ebf61a8776c8564e68e9e396ebc68e4f746370">npack</a>;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> pv = Kokkos::ThreadVectorRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, n);</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160; </div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <span class="comment">// Compute pnh(1:nlev,:). pnh(nlevp,:) is not needed.</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> f1 = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>) {</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a> = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        <a class="code" href="class_homme_1_1_equation_of_state.html#a3230bfa9a71caaef91f6121279bc86f6">EquationOfState::compute_pnh_and_exner</a>(</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;          vtheta_dp(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i), dphi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i), pnh(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i), exner(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i));</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;      };</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;      parallel_for(pv, <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a>);</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    };</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    parallel_for(Kokkos::TeamThreadRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>), f1);</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160; </div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <span class="comment">// Compute dpnh_dp_i(1:nlev,:), d(pnh)/d(pi) at interfaces. Use one-sided</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    <span class="comment">// differences at boundaries. Do not compute dpnh_dp_i(nlevp,:).</span></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>(); <span class="comment">// wait for pnh</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> f2 = [&amp;] (<span class="keyword">const</span> int) {</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> k0 = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> pnh_i_0 = hvcoord.<a class="code" href="class_homme_1_1_hybrid_v_coord.html#ad14212aa36c2486b505d7d3675b77f9b">hybrid_ai0</a>*hvcoord.<a class="code" href="class_homme_1_1_hybrid_v_coord.html#a92355d60a0677588145a7c956b4a2214">ps0</a>; <span class="comment">// hydrostatic ptop</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        dpnh_dp_i(0,i) = 2*(pnh(0,i) - pnh_i_0)/dp3d(0,i);</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;      };</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;      parallel_for(pv, k0);</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    };</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    parallel_for(Kokkos::TeamThreadRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, 1), f2);</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> f3 = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> km1) {</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> = km1 + 1;</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> kr = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        dpnh_dp_i(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = ((pnh(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) - pnh(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>-1,i))/</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                          ((dp3d(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>-1,i) + dp3d(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i))/2));</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;      };</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;      parallel_for(pv, kr);</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    };</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    parallel_for(Kokkos::TeamThreadRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>-1), f3);</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;  }</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160; </div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;  <span class="comment">// Suboptimal impl of the initial guess that uses the policy native to the</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;  <span class="comment">// DIRK Newton iteration. It is suboptimal because there are two scans, and</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;  <span class="comment">// both the memory layout and the parallelization are suboptimal for these.</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;  <span class="comment">// run_initial_guess, above, runs a separate kernel with optimal layout and</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  <span class="comment">// parallelization.</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Rphis, <span class="keyword">typename</span> R, <span class="keyword">typename</span> W&gt;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;  KOKKOS_INLINE_FUNCTION <span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00602"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a0852061e230d0e46651f404401b3e3fe">  602</a></span>&#160;  <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a0852061e230d0e46651f404401b3e3fe">phi_from_eos</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> nvec,</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                <span class="keyword">const</span> <a class="code" href="class_homme_1_1_hybrid_v_coord.html">HybridVCoord</a>&amp; hvcoord, <span class="keyword">const</span> Rphis&amp; phis, <span class="keyword">const</span> R&amp; vtheta_dp, <span class="keyword">const</span> R&amp; <a class="code" href="namespacedcmip2012__test5.html#ad259dec8945b10d8b2c6226e53589de5">dp</a>,</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                <span class="comment">// phi_i on output</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                <span class="keyword">const</span> W&amp; wrk)</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;  {</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    <span class="comment">// Scan to compute pressure.</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, 1, nvec, [&amp;] (<span class="keywordtype">int</span>, <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;      wrk(0,i) = hvcoord.<a class="code" href="class_homme_1_1_hybrid_v_coord.html#ad14212aa36c2486b505d7d3675b77f9b">hybrid_ai0</a>*hvcoord.<a class="code" href="class_homme_1_1_hybrid_v_coord.html#a92355d60a0677588145a7c956b4a2214">ps0</a>;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> = 0; <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> &lt; <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>; ++<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>) {</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>+1,i) = wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) + <a class="code" href="namespacedcmip2012__test5.html#ad259dec8945b10d8b2c6226e53589de5">dp</a>(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i);      <span class="comment">// p_i at interface k+1</span></div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = (wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>+1,i) + wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i))/2; <span class="comment">// p_m at midpoint  k</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;      }</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    });</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    <span class="comment">// Do most of the flops.</span></div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;      wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = <a class="code" href="class_homme_1_1_equation_of_state.html#a3eac62e99215950fd8507ccfc7b94378">EquationOfState::compute_dphi</a>(vtheta_dp(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i), wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)); <span class="comment">// dphi</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    });</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <span class="comment">// Scan to compute phi_i.</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, 1, nvec, [&amp;] (<span class="keywordtype">int</span>, <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;      <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a261c733c3be6b14ca97ce4d167cebe5d">set_phis</a>(i, phis, wrk);</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> = <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>-1; <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> &gt;= 0; --<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>)</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>+1,i) + wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i); <span class="comment">// phi_i below + dphi</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    });</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;  }</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160; </div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Rphis, <span class="keyword">typename</span> W&gt;</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;  KOKKOS_INLINE_FUNCTION <span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00631"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a261c733c3be6b14ca97ce4d167cebe5d">  631</a></span>&#160;  <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a261c733c3be6b14ca97ce4d167cebe5d">set_phis</a> (<span class="keyword">const</span> <span class="keywordtype">int</span> i, <span class="keyword">const</span> Rphis&amp; phis, <span class="keyword">const</span> W&amp; phi_i) {</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s = 0; s &lt; <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>; ++s) {</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">int</span> idx = i*<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> + s, gi = idx / NP, gj = idx % NP;</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a> % <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> != 0 &amp;&amp; idx &gt;= <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a>) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;      phi_i(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a452f94a8328ea08acda34ca006e04865a8297a59ae2729df8b63a96a014a2df95">num_phys_lev</a>,i)[s] = phis(gi,gj);</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    }    </div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;  }</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160; </div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;  KOKKOS_INLINE_FUNCTION</div>
<div class="line"><a name="l00640"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#ab72c4b923177016f64e0db275c5797c7">  640</a></span>&#160;  <span class="keyword">static</span> <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ab72c4b923177016f64e0db275c5797c7">calc_wmax</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> nvec,</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                         <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a>&amp; w) {</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    <span class="keyword">using</span> Kokkos::parallel_reduce;</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <span class="keyword">using</span> Kokkos::TeamThreadRange;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    <span class="keyword">using</span> Kokkos::ThreadVectorRange;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160; </div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> f = [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a>&amp; maxval) {</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a> = [&amp;] (<span class="keywordtype">int</span> i, <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a>&amp; lmaxval) {</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> v = w(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i);</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s = 0; s &lt; <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>; ++s) {</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a> % <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> != 0 &amp;&amp; i*<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> + s &gt;= <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a>) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;          lmaxval = <a class="code" href="namespace_homme.html#a103d631703618e0820c07f4bf5f31c24">max</a>(lmaxval, std::abs(v[s]));</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        }</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;      };</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;      <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> lmaxval;</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> vr = ThreadVectorRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, nvec);</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;      parallel_reduce(vr, <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a>, Kokkos::Max&lt;Real&gt;(lmaxval));</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;      maxval = <a class="code" href="namespace_homme.html#a103d631703618e0820c07f4bf5f31c24">max</a>(maxval, lmaxval); <span class="comment">// benign write race</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    };</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> wmax;</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> tr = TeamThreadRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>);</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    parallel_reduce(tr, f, Kokkos::Max&lt;Real&gt;(wmax));</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="namespace_homme.html#a103d631703618e0820c07f4bf5f31c24">max</a>(1.0, wmax);</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;  }</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160; </div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;  KOKKOS_INLINE_FUNCTION</div>
<div class="line"><a name="l00666"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#ae7960c37222103c9425822489f3a0ef1">  666</a></span>&#160;  <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ae7960c37222103c9425822489f3a0ef1">exit_on_step</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> nvec,</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                            <span class="keyword">const</span> <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a>&amp; wmax, <span class="keyword">const</span> <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a>&amp; deltatol,</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                            <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a63b6c5ff55d179bde23f77243e66314c">LinearSystemSlot</a>&amp; <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>, <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a>&amp; deltaerr) {</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;    <span class="keyword">using</span> Kokkos::parallel_reduce;</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    <span class="keyword">using</span> Kokkos::TeamThreadRange;</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    <span class="keyword">using</span> Kokkos::ThreadVectorRange;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160; </div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    <span class="comment">// deltaerr = maxval(abs(x) / wmax</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> f = [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a>&amp; maxval) {</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a> = [&amp;] (<span class="keywordtype">int</span> i, <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a>&amp; lmaxval) {</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> v = <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i);</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s = 0; s &lt; <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>; ++s) {</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a> % <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> != 0 &amp;&amp; i*<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> + s &gt;= <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a>) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;          lmaxval = <a class="code" href="namespace_homme.html#a103d631703618e0820c07f4bf5f31c24">max</a>(lmaxval, std::abs(v[s]));</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;        }</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;      };</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;      <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> lmaxval;</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> vr = ThreadVectorRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, nvec);</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;      parallel_reduce(vr, <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a>, Kokkos::Max&lt;Real&gt;(lmaxval));</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;      maxval = <a class="code" href="namespace_homme.html#a103d631703618e0820c07f4bf5f31c24">max</a>(maxval, lmaxval); <span class="comment">// benign write race</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    };</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> tr = TeamThreadRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>);</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    parallel_reduce(tr, f, Kokkos::Max&lt;Real&gt;(deltaerr));</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    <span class="keywordflow">return</span> deltaerr/wmax &lt; deltatol;</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;  }</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160; </div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;  <span class="comment">/* Compute Jacobian of F(phi) = sum(dphi) + const + (dt*g)^2 *(1-dp/dpi)</span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="comment">     column wise with respect to phi. Form the tridiagonal analytical Jacobian J</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;<span class="comment">     to solve J * x = -f.</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;<span class="comment">     This code will need to change when the equation of state is changed.</span></div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> R, <span class="keyword">typename</span> W&gt;</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;  KOKKOS_INLINE_FUNCTION</div>
<div class="line"><a name="l00700"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#ac2a8cf41d71c13c423ab248c1f9426bf">  700</a></span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ac2a8cf41d71c13c423ab248c1f9426bf">calc_jacobian</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv, <span class="keyword">const</span> <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a>&amp; dt2,</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;                             <span class="comment">// All arrays are in DIRK format.</span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;                             <span class="keyword">const</span> R&amp; dp3d, <span class="keyword">const</span> R&amp; dphi, <span class="keyword">const</span> R&amp; pnh,</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;                             <span class="keyword">const</span> W&amp; dl, <span class="keyword">const</span> W&amp; d, <span class="keyword">const</span> W&amp; du,</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;                             <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a> = NUM_PHYSICAL_LEV) {</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    <span class="keyword">using</span> Kokkos::parallel_for;</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160; </div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> n = <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a69c849c45658f79de0fb94c2468ebf61a8776c8564e68e9e396ebc68e4f746370">npack</a>;</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> pv = Kokkos::ThreadVectorRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, n);</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> pt1 = Kokkos::TeamThreadRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, 1);</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160; </div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    <span class="keyword">const</span> <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> <a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a> = <a class="code" href="namespace_homme.html#a8df903ffba928e93e306202109fa9141">square</a>(dt2*<a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">PhysicalConstants::g</a>)/(1 - <a class="code" href="namespace_homme_1_1_physical_constants.html#a3dbd54984088c69072220a929476d62f">PhysicalConstants::kappa</a>);</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160; </div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> f1 = [&amp;] (<span class="keyword">const</span> int) {</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> ks = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> i) { <span class="comment">// first Jacobian row</span></div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> = 0;</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespacebaroclinic__wave.html#acf8e56bd7dfdfd2c39e16dfa491a5293">b</a> = <a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>/dp3d(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i);</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        du(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = 2*<a class="code" href="namespacebaroclinic__wave.html#acf8e56bd7dfdfd2c39e16dfa491a5293">b</a>*(pnh(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)/dphi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i));</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;        d (<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = 1 - du(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i);</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;      };</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;      parallel_for(pv, ks);</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    };</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    parallel_for(pt1, f1);</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> f2 = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> km1) {</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> = km1 + 1;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> kmid = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> i) { <span class="comment">// middle Jacobian rows</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespacebaroclinic__wave.html#acf8e56bd7dfdfd2c39e16dfa491a5293">b</a> = 2*<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>/(dp3d(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>-1,i) + dp3d(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i));</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        dl(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = <a class="code" href="namespacebaroclinic__wave.html#acf8e56bd7dfdfd2c39e16dfa491a5293">b</a>*(pnh(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>-1,i)/dphi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>-1,i));</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        du(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = <a class="code" href="namespacebaroclinic__wave.html#acf8e56bd7dfdfd2c39e16dfa491a5293">b</a>*(pnh(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>  ,i)/dphi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>  ,i));</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        <span class="comment">// In all rows k,</span></div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        <span class="comment">//     dl &lt;= 0, du &lt;= 0,</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        <span class="comment">// and thus</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        <span class="comment">//     d = 1 + |dl| + |du| &gt; |dl| + |du|,</span></div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;        <span class="comment">// making this Jacobian matrix strictly diagonally dominant. Thus, we</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        <span class="comment">// need not pivot when factorizing the matrix.</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;        d (<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = 1 - dl(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) - du(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i);</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;      };</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;      parallel_for(pv, kmid);</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    };</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    parallel_for(Kokkos::TeamThreadRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>-2), f2);</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> f3 = [&amp;] (<span class="keyword">const</span> int) {</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> ke = [&amp;] (<span class="keyword">const</span> <span class="keywordtype">int</span> i) { <span class="comment">// last Jacobian row</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> = <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>-1;</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespacebaroclinic__wave.html#acf8e56bd7dfdfd2c39e16dfa491a5293">b</a> = 2*<a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>/(dp3d(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>-1,i) + dp3d(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i));</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        dl(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = <a class="code" href="namespacebaroclinic__wave.html#acf8e56bd7dfdfd2c39e16dfa491a5293">b</a>*(pnh(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>-1,i)/dphi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>-1,i));</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;        d (<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = 1 - dl(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) - <a class="code" href="namespacebaroclinic__wave.html#acf8e56bd7dfdfd2c39e16dfa491a5293">b</a>*(pnh(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)/dphi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i));        </div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;      };</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;      parallel_for(pv, ke);</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    };</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;    parallel_for(pt1, f3);</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;  }</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160; </div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> W&gt;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;  KOKKOS_INLINE_FUNCTION</div>
<div class="line"><a name="l00754"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#abc314dac1110aeebebd6d1ca8fa7ee8a">  754</a></span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abc314dac1110aeebebd6d1ca8fa7ee8a">solve</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv,</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                     <span class="keyword">const</span> W&amp; dl, <span class="keyword">const</span> W&amp; d, <span class="keyword">const</span> W&amp; du, <span class="keyword">const</span> W&amp; <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>) {</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    assert(d.extent_int(0) == <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a452f94a8328ea08acda34ca006e04865a8297a59ae2729df8b63a96a014a2df95">num_phys_lev</a>);</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="struct_homme_1_1_on_gpu.html">OnGpu&lt;ExecSpace&gt;::value</a>)</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;      <a class="code" href="namespacescream_1_1tridiag.html#adaae7c88733cd352dd3009f48a32aea8">scream::tridiag::cr</a>(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, dl, d, du, <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>);</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> f = [&amp;] () { <a class="code" href="namespacescream_1_1tridiag.html#a9f3fbcf7c5799f7314ed025209c9428b">scream::tridiag::thomas</a>(dl, d, du, <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>); };</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;      Kokkos::single(Kokkos::PerTeam(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>), f);</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    }</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;  }</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160; </div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> W&gt;</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;  KOKKOS_INLINE_FUNCTION</div>
<div class="line"><a name="l00767"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#ab5831cc2145e27a1bdc82cf2dbc94eaf">  767</a></span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#ab5831cc2145e27a1bdc82cf2dbc94eaf">solvebfb</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv,</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;                        <span class="keyword">const</span> W&amp; dl, <span class="keyword">const</span> W&amp; d, <span class="keyword">const</span> W&amp; du, <span class="keyword">const</span> W&amp; <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>) {</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    assert(d.extent_int(0) == <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a452f94a8328ea08acda34ca006e04865a8297a59ae2729df8b63a96a014a2df95">num_phys_lev</a>);</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    <a class="code" href="namespacescream_1_1tridiag.html#a3442f28bf93b0c32e55dafb50c32e0fc">scream::tridiag::bfb</a>(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, dl, d, du, <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>);</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;  }</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160; </div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;  <span class="comment">// Determine a step length 0 &lt; alpha &lt;= 1.</span></div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;  KOKKOS_INLINE_FUNCTION <span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00775"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a3adfd04dd5251eaa7542e40bd80cee04">  775</a></span>&#160;  <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a3adfd04dd5251eaa7542e40bd80cee04">calc_step_size</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> nvec,</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;                  <span class="keyword">const</span> <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a>&amp; grav, <span class="keyword">const</span> <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a>&amp; dt2,</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;                  <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a>&amp; dphi_n0, <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a>&amp; w_np1, <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a63b6c5ff55d179bde23f77243e66314c">LinearSystemSlot</a>&amp; <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>,</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;                  <span class="comment">// On input, wrk(0,i)[s] is 1 if the step length should be</span></div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;                  <span class="comment">// smaller. On output, alpha is in wrk(2,:).</span></div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;                  <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a>&amp; wrk) {</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    <span class="keyword">using</span> Kokkos::parallel_reduce;</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="keyword">using</span> Kokkos::parallel_for;</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    <span class="keyword">using</span> Kokkos::TeamThreadRange;</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    <span class="keyword">using</span> Kokkos::ThreadVectorRange;</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    <span class="comment">// Set all alpha_k to 1 except row 0. Include row nlev for use as a flag.</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) { wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>+1,i) = 1; });</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s = 0; s &lt; <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>; ++s) {</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a> % <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> != 0 &amp;&amp; i*<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> + s &gt;= <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a>) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;        <span class="keywordflow">if</span> (wrk(0,i)[s] == 0) {</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;          <span class="comment">// Indicate this column is already good.</span></div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;          wrk(<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>,i)[s] = 0;</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;          <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;        }</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> <a class="code" href="namespacephysical__constants.html#a8f292bec2061eac2b56d3f01a57eeff2">dx</a>, dw;</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> &lt; <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>-1) {</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;          <a class="code" href="namespacephysical__constants.html#a8f292bec2061eac2b56d3f01a57eeff2">dx</a> =     <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>+1,i)[s] -     <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)[s];</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;          dw = w_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>+1,i)[s] - w_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)[s];</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;          <a class="code" href="namespacephysical__constants.html#a8f292bec2061eac2b56d3f01a57eeff2">dx</a> = -    <a class="code" href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">x</a>(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)[s];</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;          dw = -w_np1(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)[s];          </div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;        }</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="namespacephysical__constants.html#a8f292bec2061eac2b56d3f01a57eeff2">dx</a> != 0) {</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;          <span class="comment">// Step length at which dphi(k,i)[s] would = 0.</span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;          <span class="keyword">const</span> <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> alpha = -(dphi_n0(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)[s] + dt2*grav*dw)/(dt2*grav*<a class="code" href="namespacephysical__constants.html#a8f292bec2061eac2b56d3f01a57eeff2">dx</a>);</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;          <span class="comment">// A negative step is irrelevant.</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;          <span class="keywordflow">if</span> (alpha &gt;= 0) wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)[s] = alpha;</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;        }</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;      }</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    });</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    <span class="comment">// Find minimum alpha in each column. This calculation is performed rarely,</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    <span class="comment">// so we can use the following suboptimal reduction arising from the</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    <span class="comment">// Newton-loop team policy without essentially any performance loss. The</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <span class="comment">// code itself is fine, but the current policy has too many threads and too</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    <span class="comment">// few vector lanes on GPU compared with the optimal policy.</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> f = [&amp;] (<span class="keywordtype">int</span> idx) {</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">int</span> i = idx / <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>, s = idx % <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>;</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;      <span class="keywordflow">if</span> (wrk(<a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>,i)[s] == 0) <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a> = [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a>&amp; lalpha) { lalpha = <a class="code" href="namespace_homme.html#aa5ee91d7c814422d140f870539a28bd1">min</a>(lalpha, wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)[s]); };</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;      <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> alpha;</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;      <span class="keyword">const</span> <span class="keyword">auto</span> vr = ThreadVectorRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>);</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;      parallel_reduce(vr, <a class="code" href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">g</a>, Kokkos::Min&lt;Real&gt;(alpha));</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;      <span class="comment">// Step halfway to the distance at which at least one dphi is 0.</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;      wrk(2,i)[s] = <a class="code" href="namespace_homme.html#aa5ee91d7c814422d140f870539a28bd1">min</a>(1.0, alpha)/2;</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    };</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> tr = TeamThreadRange(kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">team</a>, <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a>));</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    parallel_for(tr, f);</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;  }</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160; </div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;  <span class="comment">// Determine whether any dphi &gt; threshold. Set the entry to threshold.</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;  KOKKOS_INLINE_FUNCTION <span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00834"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a91451cda2de85e1624b5376c6cae7893">  834</a></span>&#160;  <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a91451cda2de85e1624b5376c6cae7893">calc_whether_gt_and_set</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> nvec,</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;                           <span class="keyword">const</span> <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> threshold,</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;                           <span class="comment">// dphi &gt; threshold?</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;                           <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a>&amp; dphi,</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;                           <span class="comment">// On output, wrk(0,:) contains 0 for no, 1 for yes;</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;                           <span class="comment">// if any is yes, then wrk(1,0) is 1, else 0.</span></div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;                           <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a>&amp; wrk) {</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, 2, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) { wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = 0; });</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s = 0; s &lt; <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>; ++s) {</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a> % <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> != 0 &amp;&amp; i*<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> + s &gt;= <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a>) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;        <span class="keywordflow">if</span> (dphi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)[s] &gt; threshold) {</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;          dphi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)[s] = threshold;</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;          wrk(0,i)[s] = 1; <span class="comment">// benign write race</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;          wrk(1,0)[0] = 1; <span class="comment">// benign write race</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;        }</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;      }</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    });</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;  }</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160; </div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;  <span class="comment">// Determine whether any dphi &gt;= threshold.</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;  KOKKOS_INLINE_FUNCTION <span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00857"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a81b5136d79fe85b544708cab3a1ca1a2">  857</a></span>&#160;  <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a81b5136d79fe85b544708cab3a1ca1a2">calc_whether_ge</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> nvec,</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;                   <span class="keyword">const</span> <a class="code" href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Real</a> threshold,</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;                   <span class="comment">// dphi &gt;= threshold?</span></div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;                   <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a>&amp; dphi,</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;                   <span class="comment">// On output, wrk(0,:) contains 0 for no, 1 for yes;</span></div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;                   <span class="comment">// if any is yes, then wrk(1,0) is 1, else 0.</span></div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                   <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a>&amp; wrk) {</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, 2, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) { wrk(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = 0; });</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    kv.<a class="code" href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">team_barrier</a>();</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, nvec, [&amp;] (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>, <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s = 0; s &lt; <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>; ++s) {</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a> % <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> != 0 &amp;&amp; i*<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> + s &gt;= <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a>) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;        <span class="keywordflow">if</span> (dphi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)[s] &gt;= threshold) {</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;          wrk(0,i)[s] = 1; <span class="comment">// benign write race</span></div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;          wrk(1,0)[0] = 1; <span class="comment">// benign write race</span></div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;        }</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;      }</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    });</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;  }</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160; </div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;  KOKKOS_INLINE_FUNCTION <span class="keyword">static</span> <span class="keywordtype">bool</span></div>
<div class="line"><a name="l00878"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a1f3aa2f68c73bded6307bf0a63835bd5">  878</a></span>&#160;  <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1f3aa2f68c73bded6307bf0a63835bd5">scan_dphi</a> (<span class="keyword">const</span> <a class="code" href="struct_homme_1_1_kernel_variables.html">KernelVariables</a>&amp; kv, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> nvec,</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;             <span class="comment">// On input, wrk(0,:) contains 0 for no, 1 for yes</span></div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;             <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a>&amp; wrk, <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a>&amp; dphi, <span class="keyword">const</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">WorkSlot</a>&amp; phi_i) {</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    <span class="comment">// imex_mod scans all cols if even one is bad. So do that here. The scan is</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    <span class="comment">// suboptimal, but it&#39;s much better to do it like this than have separate</span></div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    <span class="comment">// kernels just b/c of a safety scan. All scans except the initial guess,</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    <span class="comment">// which we do indeed handle in a separate kernel, are triggered only very</span></div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    <span class="comment">// occasionally.</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">loop_ki</a>(kv, 1, nvec, [&amp;] (<span class="keywordtype">int</span>, <span class="keywordtype">int</span> i) {</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> = <a class="code" href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">nlev</a>-1; <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> &gt;= 0; --<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>)</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        phi_i(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i) = phi_i(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>+1,i) - dphi(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i);</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    });</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;  }</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160; </div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;  <span class="comment">// Debug routine, not for GPU.</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> R&gt;</div>
<div class="line"><a name="l00895"></a><span class="lineno"><a class="line" href="struct_homme_1_1_dirk_functor_impl.html#a26a768fa7d6191f255e726954a60d6a9">  895</a></span>&#160;  <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a26a768fa7d6191f255e726954a60d6a9">good</a> (<span class="keyword">const</span> R&amp; <a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>) {</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a26a768fa7d6191f255e726954a60d6a9">good</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> = 0; <a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a> &lt; <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a452f94a8328ea08acda34ca006e04865a8297a59ae2729df8b63a96a014a2df95">num_phys_lev</a>; ++<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>)</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>.extent_int(1); ++i)</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s = 0; s &lt; <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a>; ++s) {</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;          <span class="keywordflow">if</span> (i*<a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">packn</a> + s &gt;= <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">scaln</a>) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;          <span class="keyword">const</span> <span class="keyword">auto</span> v = <a class="code" href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">a</a>(<a class="code" href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">k</a>,i)[s];</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="namespacesurfaces__mod.html#acd025aa90ee60dfdb616983bad0aa680">std::isnan</a>(v) || std::isinf(v)) <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a26a768fa7d6191f255e726954a60d6a9">good</a> = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;        }</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="struct_homme_1_1_dirk_functor_impl.html#a26a768fa7d6191f255e726954a60d6a9">good</a>;</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;  }</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;};</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160; </div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;} <span class="comment">// namespace Homme</span></div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160; </div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;<span class="preprocessor">#endif </span><span class="comment">// HOMMEXX_DIRK_FUNCTOR_IMPL_HPP</span></div>
<div class="ttc" id="a_element_ops_8hpp_html"><div class="ttname"><a href="_element_ops_8hpp.html">ElementOps.hpp</a></div></div>
<div class="ttc" id="a_elements_8hpp_html"><div class="ttname"><a href="_elements_8hpp.html">Elements.hpp</a></div></div>
<div class="ttc" id="a_equation_of_state_8hpp_html"><div class="ttname"><a href="_equation_of_state_8hpp.html">EquationOfState.hpp</a></div></div>
<div class="ttc" id="a_error_defs_8hpp_html"><div class="ttname"><a href="_error_defs_8hpp.html">ErrorDefs.hpp</a></div></div>
<div class="ttc" id="a_functors_buffers_manager_8hpp_html"><div class="ttname"><a href="_functors_buffers_manager_8hpp.html">FunctorsBuffersManager.hpp</a></div></div>
<div class="ttc" id="a_hybrid_v_coord_8hpp_html"><div class="ttname"><a href="_hybrid_v_coord_8hpp.html">HybridVCoord.hpp</a></div></div>
<div class="ttc" id="a_kernel_variables_8hpp_html"><div class="ttname"><a href="_kernel_variables_8hpp.html">KernelVariables.hpp</a></div></div>
<div class="ttc" id="a_physical_constants_8hpp_html"><div class="ttname"><a href="_physical_constants_8hpp.html">PhysicalConstants.hpp</a></div></div>
<div class="ttc" id="a_types_8hpp_html"><div class="ttname"><a href="_types_8hpp.html">Types.hpp</a></div></div>
<div class="ttc" id="aclass_homme_1_1___team_utils_common_base_html_abee222dbd07f3305af7b96e25dba9c75"><div class="ttname"><a href="class_homme_1_1___team_utils_common_base.html#abee222dbd07f3305af7b96e25dba9c75">Homme::_TeamUtilsCommonBase::get_num_ws_slots</a></div><div class="ttdeci">int get_num_ws_slots() const</div><div class="ttdef"><b>Definition:</b> <a href="kokkos__utils_8hpp_source.html#l00057">kokkos_utils.hpp:57</a></div></div>
<div class="ttc" id="aclass_homme_1_1_element_ops_html"><div class="ttname"><a href="class_homme_1_1_element_ops.html">Homme::ElementOps</a></div><div class="ttdef"><b>Definition:</b> <a href="_element_ops_8hpp_source.html#l00014">ElementOps.hpp:14</a></div></div>
<div class="ttc" id="aclass_homme_1_1_element_ops_html_a4a9e0b79f464751ea3e7e638b5477fae"><div class="ttname"><a href="class_homme_1_1_element_ops.html#a4a9e0b79f464751ea3e7e638b5477fae">Homme::ElementOps::init</a></div><div class="ttdeci">void init(const HybridVCoord &amp;hvcoord)</div><div class="ttdef"><b>Definition:</b> <a href="_element_ops_8hpp_source.html#l00022">ElementOps.hpp:22</a></div></div>
<div class="ttc" id="aclass_homme_1_1_element_ops_html_aa30951180b2e0480a83418e99faf6374"><div class="ttname"><a href="class_homme_1_1_element_ops.html#aa30951180b2e0480a83418e99faf6374">Homme::ElementOps::compute_hydrostatic_p</a></div><div class="ttdeci">KOKKOS_INLINE_FUNCTION void compute_hydrostatic_p(const KernelVariables &amp;kv, const ExecViewUnmanaged&lt; const Scalar[NUM_LEV]&gt; &amp;dp, const ExecViewUnmanaged&lt; Scalar[NUM_LEV_P]&gt; &amp;p_i, const ExecViewUnmanaged&lt; Scalar[NUM_LEV]&gt; &amp;pi) const</div><div class="ttdef"><b>Definition:</b> <a href="_element_ops_8hpp_source.html#l00047">ElementOps.hpp:47</a></div></div>
<div class="ttc" id="aclass_homme_1_1_elements_derived_state_html_acbc1911bd13f604d9b5341bf5e4d41b7"><div class="ttname"><a href="class_homme_1_1_elements_derived_state.html#acbc1911bd13f604d9b5341bf5e4d41b7">Homme::ElementsDerivedState::m_divdp_proj</a></div><div class="ttdeci">ExecViewManaged&lt; Scalar *[NP][NP][NUM_LEV]&gt; m_divdp_proj</div><div class="ttdef"><b>Definition:</b> <a href="_elements_derived_state_8hpp_source.html#l00028">ElementsDerivedState.hpp:28</a></div></div>
<div class="ttc" id="aclass_homme_1_1_elements_geometry_html_a245d6743bc0f3d3d6fc41a27d17764f5"><div class="ttname"><a href="class_homme_1_1_elements_geometry.html#a245d6743bc0f3d3d6fc41a27d17764f5">Homme::ElementsGeometry::m_phis</a></div><div class="ttdeci">ExecViewManaged&lt; Real *[NP][NP]&gt; m_phis</div><div class="ttdef"><b>Definition:</b> <a href="_elements_geometry_8hpp_source.html#l00037">ElementsGeometry.hpp:37</a></div></div>
<div class="ttc" id="aclass_homme_1_1_elements_geometry_html_a966d0386f61585ab792d357a6e9da7fb"><div class="ttname"><a href="class_homme_1_1_elements_geometry.html#a966d0386f61585ab792d357a6e9da7fb">Homme::ElementsGeometry::m_gradphis</a></div><div class="ttdeci">ExecViewManaged&lt; Real *[2][NP][NP]&gt; m_gradphis</div><div class="ttdef"><b>Definition:</b> <a href="_elements_geometry_8hpp_source.html#l00038">ElementsGeometry.hpp:38</a></div></div>
<div class="ttc" id="aclass_homme_1_1_elements_html"><div class="ttname"><a href="class_homme_1_1_elements.html">Homme::Elements</a></div><div class="ttdef"><b>Definition:</b> <a href="_elements_8hpp_source.html#l00032">Elements.hpp:32</a></div></div>
<div class="ttc" id="aclass_homme_1_1_elements_html_a26a237a775286be986bc269e18c0d764"><div class="ttname"><a href="class_homme_1_1_elements.html#a26a237a775286be986bc269e18c0d764">Homme::Elements::m_geometry</a></div><div class="ttdeci">ElementsGeometry m_geometry</div><div class="ttdef"><b>Definition:</b> <a href="_elements_8hpp_source.html#l00035">Elements.hpp:35</a></div></div>
<div class="ttc" id="aclass_homme_1_1_elements_html_a45ed484dcba35066f7511ed61d652541"><div class="ttname"><a href="class_homme_1_1_elements.html#a45ed484dcba35066f7511ed61d652541">Homme::Elements::m_state</a></div><div class="ttdeci">ElementsState m_state</div><div class="ttdef"><b>Definition:</b> <a href="_elements_8hpp_source.html#l00036">Elements.hpp:36</a></div></div>
<div class="ttc" id="aclass_homme_1_1_elements_html_aaf5acfcae5ba0ed8cb567b564f997baf"><div class="ttname"><a href="class_homme_1_1_elements.html#aaf5acfcae5ba0ed8cb567b564f997baf">Homme::Elements::m_derived</a></div><div class="ttdeci">ElementsDerivedState m_derived</div><div class="ttdef"><b>Definition:</b> <a href="_elements_8hpp_source.html#l00037">Elements.hpp:37</a></div></div>
<div class="ttc" id="aclass_homme_1_1_elements_state_html_a0a00f14cc800bce90d8e6b9712a053fd"><div class="ttname"><a href="class_homme_1_1_elements_state.html#a0a00f14cc800bce90d8e6b9712a053fd">Homme::ElementsState::m_v</a></div><div class="ttdeci">ExecViewManaged&lt; Scalar *[NUM_TIME_LEVELS][2][NP][NP][NUM_LEV]&gt; m_v</div><div class="ttdef"><b>Definition:</b> <a href="preqx__kokkos_2cxx_2_elements_state_8hpp_source.html#l00020">ElementsState.hpp:20</a></div></div>
<div class="ttc" id="aclass_homme_1_1_elements_state_html_a28d9e924694607074a3acfe1c9998003"><div class="ttname"><a href="class_homme_1_1_elements_state.html#a28d9e924694607074a3acfe1c9998003">Homme::ElementsState::m_w_i</a></div><div class="ttdeci">ExecViewManaged&lt; Scalar *[NUM_TIME_LEVELS][NP][NP][NUM_LEV_P]&gt; m_w_i</div><div class="ttdef"><b>Definition:</b> <a href="theta-l__kokkos_2cxx_2_elements_state_8hpp_source.html#l00047">ElementsState.hpp:47</a></div></div>
<div class="ttc" id="aclass_homme_1_1_elements_state_html_a8198395c8fab8ed92076e045cefb43e5"><div class="ttname"><a href="class_homme_1_1_elements_state.html#a8198395c8fab8ed92076e045cefb43e5">Homme::ElementsState::m_phinh_i</a></div><div class="ttdeci">ExecViewManaged&lt; Scalar *[NUM_TIME_LEVELS][NP][NP][NUM_LEV_P]&gt; m_phinh_i</div><div class="ttdef"><b>Definition:</b> <a href="theta-l__kokkos_2cxx_2_elements_state_8hpp_source.html#l00049">ElementsState.hpp:49</a></div></div>
<div class="ttc" id="aclass_homme_1_1_elements_state_html_abaceb199362f44be6f65fad0412aa4f7"><div class="ttname"><a href="class_homme_1_1_elements_state.html#abaceb199362f44be6f65fad0412aa4f7">Homme::ElementsState::m_dp3d</a></div><div class="ttdeci">ExecViewManaged&lt; Scalar *[NUM_TIME_LEVELS][NP][NP][NUM_LEV]&gt; m_dp3d</div><div class="ttdef"><b>Definition:</b> <a href="preqx__kokkos_2cxx_2_elements_state_8hpp_source.html#l00024">ElementsState.hpp:24</a></div></div>
<div class="ttc" id="aclass_homme_1_1_elements_state_html_ac439b933e57d3d4eaea975240f4c7e37"><div class="ttname"><a href="class_homme_1_1_elements_state.html#ac439b933e57d3d4eaea975240f4c7e37">Homme::ElementsState::m_vtheta_dp</a></div><div class="ttdeci">ExecViewManaged&lt; Scalar *[NUM_TIME_LEVELS][NP][NP][NUM_LEV]&gt; m_vtheta_dp</div><div class="ttdef"><b>Definition:</b> <a href="theta-l__kokkos_2cxx_2_elements_state_8hpp_source.html#l00048">ElementsState.hpp:48</a></div></div>
<div class="ttc" id="aclass_homme_1_1_equation_of_state_html_a3230bfa9a71caaef91f6121279bc86f6"><div class="ttname"><a href="class_homme_1_1_equation_of_state.html#a3230bfa9a71caaef91f6121279bc86f6">Homme::EquationOfState::compute_pnh_and_exner</a></div><div class="ttdeci">KOKKOS_INLINE_FUNCTION void compute_pnh_and_exner(const KernelVariables &amp;kv, const VThetaProvider &amp;vtheta_dp, const PhiProvider &amp;phi_i, const ExecViewUnmanaged&lt; Scalar[NUM_LEV]&gt; &amp;pnh, const ExecViewUnmanaged&lt; Scalar[NUM_LEV]&gt; &amp;exner) const</div><div class="ttdef"><b>Definition:</b> <a href="_equation_of_state_8hpp_source.html#l00053">EquationOfState.hpp:53</a></div></div>
<div class="ttc" id="aclass_homme_1_1_equation_of_state_html_a3eac62e99215950fd8507ccfc7b94378"><div class="ttname"><a href="class_homme_1_1_equation_of_state.html#a3eac62e99215950fd8507ccfc7b94378">Homme::EquationOfState::compute_dphi</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION Scalar compute_dphi(const Scalar &amp;vtheta_dp, const Scalar &amp;p)</div><div class="ttdef"><b>Definition:</b> <a href="_equation_of_state_8hpp_source.html#l00182">EquationOfState.hpp:182</a></div></div>
<div class="ttc" id="aclass_homme_1_1_equation_of_state_html_aa0dc6b8c326b5f6acd07ce25658f652b"><div class="ttname"><a href="class_homme_1_1_equation_of_state.html#aa0dc6b8c326b5f6acd07ce25658f652b">Homme::EquationOfState::compute_phi_i</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION void compute_phi_i(const KernelVariables &amp;kv, const ExecViewUnmanaged&lt; const Real[NP][NP] &gt; &amp;phis, const ExecViewUnmanaged&lt; const Scalar[NP][NP][NUM_LEV] &gt; &amp;vtheta_dp, const ExecViewUnmanaged&lt; const Scalar[NP][NP][NUM_LEV] &gt; &amp;p, const ExecViewUnmanaged&lt; Scalar[NP][NP][NUM_LEV_P]&gt; &amp;phi_i)</div><div class="ttdef"><b>Definition:</b> <a href="_equation_of_state_8hpp_source.html#l00144">EquationOfState.hpp:144</a></div></div>
<div class="ttc" id="aclass_homme_1_1_hybrid_v_coord_html"><div class="ttname"><a href="class_homme_1_1_hybrid_v_coord.html">Homme::HybridVCoord</a></div><div class="ttdef"><b>Definition:</b> <a href="_hybrid_v_coord_8hpp_source.html#l00019">HybridVCoord.hpp:20</a></div></div>
<div class="ttc" id="aclass_homme_1_1_hybrid_v_coord_html_a92355d60a0677588145a7c956b4a2214"><div class="ttname"><a href="class_homme_1_1_hybrid_v_coord.html#a92355d60a0677588145a7c956b4a2214">Homme::HybridVCoord::ps0</a></div><div class="ttdeci">Real ps0</div><div class="ttdef"><b>Definition:</b> <a href="_hybrid_v_coord_8hpp_source.html#l00036">HybridVCoord.hpp:36</a></div></div>
<div class="ttc" id="aclass_homme_1_1_hybrid_v_coord_html_acb82e2af73773e56e92ec2323a483ffd"><div class="ttname"><a href="class_homme_1_1_hybrid_v_coord.html#acb82e2af73773e56e92ec2323a483ffd">Homme::HybridVCoord::hybrid_bi</a></div><div class="ttdeci">ExecViewUnmanaged&lt; Real[NUM_INTERFACE_LEV]&gt; hybrid_bi</div><div class="ttdef"><b>Definition:</b> <a href="_hybrid_v_coord_8hpp_source.html#l00046">HybridVCoord.hpp:46</a></div></div>
<div class="ttc" id="aclass_homme_1_1_hybrid_v_coord_html_ad14212aa36c2486b505d7d3675b77f9b"><div class="ttname"><a href="class_homme_1_1_hybrid_v_coord.html#ad14212aa36c2486b505d7d3675b77f9b">Homme::HybridVCoord::hybrid_ai0</a></div><div class="ttdeci">Real hybrid_ai0</div><div class="ttdef"><b>Definition:</b> <a href="_hybrid_v_coord_8hpp_source.html#l00037">HybridVCoord.hpp:37</a></div></div>
<div class="ttc" id="aclass_homme_1_1_team_utils_html"><div class="ttname"><a href="class_homme_1_1_team_utils.html">Homme::TeamUtils&lt; ExecSpace &gt;</a></div></div>
<div class="ttc" id="aclass_kokkos_kernels_1_1_batched_1_1_experimental_1_1_vector_html"><div class="ttname"><a href="class_kokkos_kernels_1_1_batched_1_1_experimental_1_1_vector.html">KokkosKernels::Batched::Experimental::Vector&lt; VectorType &gt;</a></div></div>
<div class="ttc" id="anamespace_homme_1_1_physical_constants_html_a3433b33c94724c45ecbe0c60e26b18fa"><div class="ttname"><a href="namespace_homme_1_1_physical_constants.html#a3433b33c94724c45ecbe0c60e26b18fa">Homme::PhysicalConstants::g</a></div><div class="ttdeci">constexpr Real g</div><div class="ttdef"><b>Definition:</b> <a href="_physical_constants_8hpp_source.html#l00023">PhysicalConstants.hpp:23</a></div></div>
<div class="ttc" id="anamespace_homme_1_1_physical_constants_html_a3dbd54984088c69072220a929476d62f"><div class="ttname"><a href="namespace_homme_1_1_physical_constants.html#a3dbd54984088c69072220a929476d62f">Homme::PhysicalConstants::kappa</a></div><div class="ttdeci">constexpr Real kappa</div><div class="ttdef"><b>Definition:</b> <a href="_physical_constants_8hpp_source.html#l00021">PhysicalConstants.hpp:21</a></div></div>
<div class="ttc" id="anamespace_homme_html"><div class="ttname"><a href="namespace_homme.html">Homme</a></div><div class="ttdef"><b>Definition:</b> <a href="preqx__kokkos_2cxx_2_caar_functor_impl_8hpp_source.html#l00032">CaarFunctorImpl.hpp:32</a></div></div>
<div class="ttc" id="anamespace_homme_html_a0f0e1a7897b0895773148728d6a74cb1"><div class="ttname"><a href="namespace_homme.html#a0f0e1a7897b0895773148728d6a74cb1">Homme::ExecSpace</a></div><div class="ttdeci">Kokkos::DefaultExecutionSpace::execution_space ExecSpace</div><div class="ttdef"><b>Definition:</b> <a href="_exec_space_defs_8hpp_source.html#l00064">ExecSpaceDefs.hpp:64</a></div></div>
<div class="ttc" id="anamespace_homme_html_a103d631703618e0820c07f4bf5f31c24"><div class="ttname"><a href="namespace_homme.html#a103d631703618e0820c07f4bf5f31c24">Homme::max</a></div><div class="ttdeci">constexpr KOKKOS_INLINE_FUNCTION FPType max(const FPType val_1, const FPType val_2)</div><div class="ttdef"><b>Definition:</b> <a href="_math_utils_8hpp_source.html#l00029">MathUtils.hpp:29</a></div></div>
<div class="ttc" id="anamespace_homme_html_a14cb237a09aa2cdfd9095a8d3b048092"><div class="ttname"><a href="namespace_homme.html#a14cb237a09aa2cdfd9095a8d3b048092">Homme::Scalar</a></div><div class="ttdeci">KokkosKernels::Batched::Experimental::Vector&lt; VectorType &gt; Scalar</div><div class="ttdef"><b>Definition:</b> <a href="_types_8hpp_source.html#l00037">Types.hpp:37</a></div></div>
<div class="ttc" id="anamespace_homme_html_a2fb615d1c0ef9769f9fe6ff030f5af5e"><div class="ttname"><a href="namespace_homme.html#a2fb615d1c0ef9769f9fe6ff030f5af5e">Homme::subview</a></div><div class="ttdeci">KOKKOS_INLINE_FUNCTION ViewUnmanaged&lt; ScalarType[DIM1], MemSpace &gt; subview(ViewType&lt; ScalarType *[DIM1], MemSpace, Properties... &gt; v_in, int ie)</div><div class="ttdef"><b>Definition:</b> <a href="_subview_utils_8hpp_source.html#l00025">SubviewUtils.hpp:25</a></div></div>
<div class="ttc" id="anamespace_homme_html_a8d2ed41bead9ec23a2a8a6c728a9f154"><div class="ttname"><a href="namespace_homme.html#a8d2ed41bead9ec23a2a8a6c728a9f154">Homme::Real</a></div><div class="ttdeci">double Real</div><div class="ttdef"><b>Definition:</b> <a href="_types_8hpp_source.html#l00025">Types.hpp:25</a></div></div>
<div class="ttc" id="anamespace_homme_html_a8df903ffba928e93e306202109fa9141"><div class="ttname"><a href="namespace_homme.html#a8df903ffba928e93e306202109fa9141">Homme::square</a></div><div class="ttdeci">constexpr KOKKOS_INLINE_FUNCTION FPType square(const FPType &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="_math_utils_8hpp_source.html#l00040">MathUtils.hpp:40</a></div></div>
<div class="ttc" id="anamespace_homme_html_aa5ee91d7c814422d140f870539a28bd1"><div class="ttname"><a href="namespace_homme.html#aa5ee91d7c814422d140f870539a28bd1">Homme::min</a></div><div class="ttdeci">constexpr KOKKOS_INLINE_FUNCTION FPType min(const FPType val_1, const FPType val_2)</div><div class="ttdef"><b>Definition:</b> <a href="_math_utils_8hpp_source.html#l00018">MathUtils.hpp:18</a></div></div>
<div class="ttc" id="anamespace_homme_html_ab890b69860872d32c6a3173f53674505"><div class="ttname"><a href="namespace_homme.html#ab890b69860872d32c6a3173f53674505">Homme::ExecViewUnmanaged</a></div><div class="ttdeci">ExecView&lt; DataType, MemoryUnmanaged &gt; ExecViewUnmanaged</div><div class="ttdef"><b>Definition:</b> <a href="_types_8hpp_source.html#l00112">Types.hpp:112</a></div></div>
<div class="ttc" id="anamespacebaroclinic__wave_html_a8619f63e6dd6db1077c1a18788afa359"><div class="ttname"><a href="namespacebaroclinic__wave.html#a8619f63e6dd6db1077c1a18788afa359">baroclinic_wave::k</a></div><div class="ttdeci">real(8), parameter k</div><div class="ttdef"><b>Definition:</b> <a href="dcmip2016-baroclinic_8_f90_source.html#l00083">dcmip2016-baroclinic.F90:83</a></div></div>
<div class="ttc" id="anamespacebaroclinic__wave_html_acf8e56bd7dfdfd2c39e16dfa491a5293"><div class="ttname"><a href="namespacebaroclinic__wave.html#acf8e56bd7dfdfd2c39e16dfa491a5293">baroclinic_wave::b</a></div><div class="ttdeci">real(8), parameter b</div><div class="ttdef"><b>Definition:</b> <a href="dcmip2016-baroclinic_8_f90_source.html#l00083">dcmip2016-baroclinic.F90:83</a></div></div>
<div class="ttc" id="anamespacecedr_1_1impl_html_afaf106747d577e9c3dc9eb35a735b8b1"><div class="ttname"><a href="namespacecedr_1_1impl.html#afaf106747d577e9c3dc9eb35a735b8b1">cedr::impl::min</a></div><div class="ttdeci">KOKKOS_INLINE_FUNCTION const T &amp; min(const T &amp;a, const T &amp;b)</div><div class="ttdef"><b>Definition:</b> <a href="compose__cedr_8cpp_source.html#l00140">compose_cedr.cpp:140</a></div></div>
<div class="ttc" id="anamespacedcmip2012__test5_html_ad259dec8945b10d8b2c6226e53589de5"><div class="ttname"><a href="namespacedcmip2012__test5.html#ad259dec8945b10d8b2c6226e53589de5">dcmip2012_test5::dp</a></div><div class="ttdeci">real(8), parameter dp</div><div class="ttdef"><b>Definition:</b> <a href="dcmip2012__test5_8_f90_source.html#l00055">dcmip2012_test5.F90:55</a></div></div>
<div class="ttc" id="anamespacedimensions__mod_html_a64817c8f3506c463c896d202d237025e"><div class="ttname"><a href="namespacedimensions__mod.html#a64817c8f3506c463c896d202d237025e">dimensions_mod::nelem</a></div><div class="ttdeci">integer, public nelem</div><div class="ttdef"><b>Definition:</b> <a href="dimensions__mod_8_f90_source.html#l00041">dimensions_mod.F90:41</a></div></div>
<div class="ttc" id="anamespacedimensions__mod_html_a6baa218e1683465acc4f37fcea8e30d5"><div class="ttname"><a href="namespacedimensions__mod.html#a6baa218e1683465acc4f37fcea8e30d5">dimensions_mod::nlev</a></div><div class="ttdeci">integer, parameter, public nlev</div><div class="ttdef"><b>Definition:</b> <a href="dimensions__mod_8_f90_source.html#l00029">dimensions_mod.F90:29</a></div></div>
<div class="ttc" id="anamespacejw_html_a655cdd60136294f8259068e09d1307ff"><div class="ttname"><a href="namespacejw.html#a655cdd60136294f8259068e09d1307ff">jw::pi</a></div><div class="ttdeci">real(r8), parameter pi</div><div class="ttdef"><b>Definition:</b> <a href="asp__tests_8_f90_source.html#l00048">asp_tests.F90:48</a></div></div>
<div class="ttc" id="anamespacejw_html_acf663523b96ec023200fa8a0f58209f8"><div class="ttname"><a href="namespacejw.html#acf663523b96ec023200fa8a0f58209f8">jw::a</a></div><div class="ttdeci">real(r8), parameter a</div><div class="ttdef"><b>Definition:</b> <a href="asp__tests_8_f90_source.html#l00048">asp_tests.F90:48</a></div></div>
<div class="ttc" id="anamespacephysical__constants_html_a8f292bec2061eac2b56d3f01a57eeff2"><div class="ttname"><a href="namespacephysical__constants.html#a8f292bec2061eac2b56d3f01a57eeff2">physical_constants::dx</a></div><div class="ttdeci">real(kind=real_kind), public dx</div><div class="ttdef"><b>Definition:</b> <a href="physical__constants_8_f90_source.html#l00079">physical_constants.F90:79</a></div></div>
<div class="ttc" id="anamespacescream_1_1tridiag_html_a3442f28bf93b0c32e55dafb50c32e0fc"><div class="ttname"><a href="namespacescream_1_1tridiag.html#a3442f28bf93b0c32e55dafb50c32e0fc">scream::tridiag::bfb</a></div><div class="ttdeci">KOKKOS_INLINE_FUNCTION void bfb(const TeamMember &amp;team, TridiagDiag dl, TridiagDiag d, TridiagDiag du, DataArray X, typename std::enable_if&lt; TridiagDiag::rank==1 &gt;::type *=0)</div><div class="ttdef"><b>Definition:</b> <a href="scream__tridiag_8hpp_source.html#l00607">scream_tridiag.hpp:607</a></div></div>
<div class="ttc" id="anamespacescream_1_1tridiag_html_a9f3fbcf7c5799f7314ed025209c9428b"><div class="ttname"><a href="namespacescream_1_1tridiag.html#a9f3fbcf7c5799f7314ed025209c9428b">scream::tridiag::thomas</a></div><div class="ttdeci">KOKKOS_INLINE_FUNCTION void thomas(const TeamMember &amp;team, TridiagDiag dl, TridiagDiag d, TridiagDiag du, DataArray X, typename std::enable_if&lt; TridiagDiag::rank==1 &gt;::type *=0)</div><div class="ttdef"><b>Definition:</b> <a href="scream__tridiag_8hpp_source.html#l00298">scream_tridiag.hpp:298</a></div></div>
<div class="ttc" id="anamespacescream_1_1tridiag_html_adaae7c88733cd352dd3009f48a32aea8"><div class="ttname"><a href="namespacescream_1_1tridiag.html#adaae7c88733cd352dd3009f48a32aea8">scream::tridiag::cr</a></div><div class="ttdeci">KOKKOS_INLINE_FUNCTION void cr(const TeamMember &amp;team, TridiagDiag dl, TridiagDiag d, TridiagDiag du, DataArray X, typename std::enable_if&lt; TridiagDiag::rank==1 &gt;::type *=0, typename std::enable_if&lt; DataArray::rank==1 &gt;::type *=0)</div><div class="ttdef"><b>Definition:</b> <a href="scream__tridiag_8hpp_source.html#l00360">scream_tridiag.hpp:360</a></div></div>
<div class="ttc" id="anamespacesupercell_html_ae57ef03dc0cb9828dbacc89aac8870c0"><div class="ttname"><a href="namespacesupercell.html#ae57ef03dc0cb9828dbacc89aac8870c0">supercell::x</a></div><div class="ttdeci">real(8), parameter x</div><div class="ttdef"><b>Definition:</b> <a href="dcmip2016-supercell_8_f90_source.html#l00084">dcmip2016-supercell.F90:84</a></div></div>
<div class="ttc" id="anamespacesurfaces__mod_html_acd025aa90ee60dfdb616983bad0aa680"><div class="ttname"><a href="namespacesurfaces__mod.html#acd025aa90ee60dfdb616983bad0aa680">surfaces_mod::isnan</a></div><div class="ttdeci">logical function isnan(a)</div><div class="ttdef"><b>Definition:</b> <a href="surfaces__mod_8_f90_source.html#l02117">surfaces_mod.F90:2118</a></div></div>
<div class="ttc" id="aprofiling_8hpp_html"><div class="ttname"><a href="profiling_8hpp.html">profiling.hpp</a></div></div>
<div class="ttc" id="ascream__tridiag_8hpp_html"><div class="ttname"><a href="scream__tridiag_8hpp.html">scream_tridiag.hpp</a></div></div>
<div class="ttc" id="astruct_homme_1_1_default_threads_distribution_html_a76d4a9f4326d5f0c392a84725fa919bb"><div class="ttname"><a href="struct_homme_1_1_default_threads_distribution.html#a76d4a9f4326d5f0c392a84725fa919bb">Homme::DefaultThreadsDistribution::team_num_threads_vectors</a></div><div class="ttdeci">static std::pair&lt; int, int &gt; team_num_threads_vectors(const int num_parallel_iterations, const ThreadPreferences tp=ThreadPreferences())</div><div class="ttdef"><b>Definition:</b> <a href="_exec_space_defs_8hpp_source.html#l00132">ExecSpaceDefs.hpp:132</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html">Homme::DirkFunctorImpl</a></div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00026">DirkFunctorImpl.hpp:26</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a0852061e230d0e46651f404401b3e3fe"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a0852061e230d0e46651f404401b3e3fe">Homme::DirkFunctorImpl::phi_from_eos</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION void phi_from_eos(const KernelVariables &amp;kv, const int nlev, const int nvec, const HybridVCoord &amp;hvcoord, const Rphis &amp;phis, const R &amp;vtheta_dp, const R &amp;dp, const W &amp;wrk)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00602">DirkFunctorImpl.hpp:602</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a1361916e03f2069e123251d70f83f928a84580cb970358855cfa71d009189ecbb"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a1361916e03f2069e123251d70f83f928a84580cb970358855cfa71d009189ecbb">Homme::DirkFunctorImpl::max_num_lev_pack</a></div><div class="ttdeci">@ max_num_lev_pack</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00030">DirkFunctorImpl.hpp:30</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a1e0bed3e80f41dfc4edc0131799205c4"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a1e0bed3e80f41dfc4edc0131799205c4">Homme::DirkFunctorImpl::WorkSlot</a></div><div class="ttdeci">Kokkos::View&lt; Scalar[num_lev_aligned][npack], Kokkos::LayoutRight, ExecSpace, Kokkos::MemoryTraits&lt; Kokkos::Unmanaged &gt; &gt; WorkSlot</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00053">DirkFunctorImpl.hpp:56</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a1ec2e98954a9fd215a4bddfcad45ad8d"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a1ec2e98954a9fd215a4bddfcad45ad8d">Homme::DirkFunctorImpl::TeamPolicy</a></div><div class="ttdeci">Kokkos::TeamPolicy&lt; ExecSpace &gt; TeamPolicy</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00047">DirkFunctorImpl.hpp:47</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a1f3aa2f68c73bded6307bf0a63835bd5"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a1f3aa2f68c73bded6307bf0a63835bd5">Homme::DirkFunctorImpl::scan_dphi</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION bool scan_dphi(const KernelVariables &amp;kv, const int nlev, const int nvec, const WorkSlot &amp;wrk, const WorkSlot &amp;dphi, const WorkSlot &amp;phi_i)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00878">DirkFunctorImpl.hpp:878</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a1f9bf50bece3e8e9f103b58d708bf1b2ae5f722bf3fa63e41dd5710ba470d70f8"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a1f9bf50bece3e8e9f103b58d708bf1b2ae5f722bf3fa63e41dd5710ba470d70f8">Homme::DirkFunctorImpl::num_work</a></div><div class="ttdeci">@ num_work</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00033">DirkFunctorImpl.hpp:33</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a213ee372718dc93f3d4fadf47574cdab"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a213ee372718dc93f3d4fadf47574cdab">Homme::DirkFunctorImpl::m_tu</a></div><div class="ttdeci">TeamUtils&lt; ExecSpace &gt; m_tu</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00089">DirkFunctorImpl.hpp:89</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a25ccb494d5f63dc7d219495bcba074cf"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a25ccb494d5f63dc7d219495bcba074cf">Homme::DirkFunctorImpl::MT</a></div><div class="ttdeci">typename TeamPolicy::member_type MT</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00048">DirkFunctorImpl.hpp:48</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a261c733c3be6b14ca97ce4d167cebe5d"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a261c733c3be6b14ca97ce4d167cebe5d">Homme::DirkFunctorImpl::set_phis</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION void set_phis(const int i, const Rphis &amp;phis, const W &amp;phi_i)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00631">DirkFunctorImpl.hpp:631</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a26a768fa7d6191f255e726954a60d6a9"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a26a768fa7d6191f255e726954a60d6a9">Homme::DirkFunctorImpl::good</a></div><div class="ttdeci">static bool good(const R &amp;a)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00895">DirkFunctorImpl.hpp:895</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a2ce1285927e9484349e45450958cf5b4"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a2ce1285927e9484349e45450958cf5b4">Homme::DirkFunctorImpl::get_work_slot</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION WorkSlot get_work_slot(const Work &amp;w, const int &amp;wi, const int &amp;si)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00070">DirkFunctorImpl.hpp:70</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a30b3cfd07066fd2adcfdbde8b05b09fb"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a30b3cfd07066fd2adcfdbde8b05b09fb">Homme::DirkFunctorImpl::m_tu_ig</a></div><div class="ttdeci">TeamUtils&lt; ExecSpace &gt; m_tu_ig</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00089">DirkFunctorImpl.hpp:89</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a39a90f678adac5e26c0b4615b096d256"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a39a90f678adac5e26c0b4615b096d256">Homme::DirkFunctorImpl::transpose</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION void transpose(const KernelVariables &amp;kv, const int nlev, const View &amp;src, const WorkSlot &amp;dst, typename std::enable_if&lt; View::rank==3 &gt;::type *=0)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00433">DirkFunctorImpl.hpp:433</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a3adfd04dd5251eaa7542e40bd80cee04"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a3adfd04dd5251eaa7542e40bd80cee04">Homme::DirkFunctorImpl::calc_step_size</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION void calc_step_size(const KernelVariables &amp;kv, const int nlev, const int nvec, const Real &amp;grav, const Real &amp;dt2, const WorkSlot &amp;dphi_n0, const WorkSlot &amp;w_np1, const LinearSystemSlot &amp;x, const WorkSlot &amp;wrk)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00775">DirkFunctorImpl.hpp:775</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a3ccb88fe20a348a06bd85094a240598b"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a3ccb88fe20a348a06bd85094a240598b">Homme::DirkFunctorImpl::transpose</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION void transpose(const KernelVariables &amp;kv, const int nlev, const WorkSlot &amp;src, const View &amp;dst, typename std::enable_if&lt; View::rank==3 &gt;::type *=0)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00464">DirkFunctorImpl.hpp:464</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a452a30294bda364b6d58fb319d855e06"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a452a30294bda364b6d58fb319d855e06">Homme::DirkFunctorImpl::m_ls</a></div><div class="ttdeci">LinearSystem m_ls</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00087">DirkFunctorImpl.hpp:87</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a452f94a8328ea08acda34ca006e04865a8297a59ae2729df8b63a96a014a2df95"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a452f94a8328ea08acda34ca006e04865a8297a59ae2729df8b63a96a014a2df95">Homme::DirkFunctorImpl::num_phys_lev</a></div><div class="ttdeci">@ num_phys_lev</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00032">DirkFunctorImpl.hpp:32</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a482a596f608fa186f224ff826fabf4af"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a482a596f608fa186f224ff826fabf4af">Homme::DirkFunctorImpl::init</a></div><div class="ttdeci">void init(const int nelem)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00103">DirkFunctorImpl.hpp:103</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a4c85036926e6c2f555f24f565bb179be"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a4c85036926e6c2f555f24f565bb179be">Homme::DirkFunctorImpl::get_ls_slot</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION LinearSystemSlot get_ls_slot(const LinearSystem &amp;w, const int &amp;wi, const int &amp;si)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00078">DirkFunctorImpl.hpp:78</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a4ccff1a1c8441c2ca1bf4c146f85e421"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a4ccff1a1c8441c2ca1bf4c146f85e421">Homme::DirkFunctorImpl::loop_ki</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION void loop_ki(const KernelVariables &amp;kv, const int klim, const int ilim, const Fn &amp;g)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00402">DirkFunctorImpl.hpp:402</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a4d29c2912f5014c0a878f48ad8268624"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a4d29c2912f5014c0a878f48ad8268624">Homme::DirkFunctorImpl::m_work</a></div><div class="ttdeci">Work m_work</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00086">DirkFunctorImpl.hpp:86</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a553a47e88f1375616594e54814915650"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a553a47e88f1375616594e54814915650">Homme::DirkFunctorImpl::run_newton</a></div><div class="ttdeci">void run_newton(int nm1, Real alphadt_nm1, int n0, Real alphadt_n0, int np1, Real dt2, const Elements &amp;e, const HybridVCoord &amp;hvcoord, const bool bfb_solver)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00207">DirkFunctorImpl.hpp:207</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a63b6c5ff55d179bde23f77243e66314c"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a63b6c5ff55d179bde23f77243e66314c">Homme::DirkFunctorImpl::LinearSystemSlot</a></div><div class="ttdeci">Kokkos::View&lt; Scalar[num_phys_lev][npack], Kokkos::LayoutRight, ExecSpace, Kokkos::MemoryTraits&lt; Kokkos::Unmanaged &gt; &gt; LinearSystemSlot</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00064">DirkFunctorImpl.hpp:67</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a69c849c45658f79de0fb94c2468ebf61a8776c8564e68e9e396ebc68e4f746370"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a69c849c45658f79de0fb94c2468ebf61a8776c8564e68e9e396ebc68e4f746370">Homme::DirkFunctorImpl::npack</a></div><div class="ttdeci">@ npack</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00029">DirkFunctorImpl.hpp:29</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a6e1ff184b5d4288c62224ed6c2d6c66a"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a6e1ff184b5d4288c62224ed6c2d6c66a">Homme::DirkFunctorImpl::run_initial_guess</a></div><div class="ttdeci">void run_initial_guess(int np1, const Elements &amp;e, const HybridVCoord &amp;hvcoord)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00160">DirkFunctorImpl.hpp:160</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a6e396d75a11df2ad21f22acda475afb7"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a6e396d75a11df2ad21f22acda475afb7">Homme::DirkFunctorImpl::LinearSystem</a></div><div class="ttdeci">Kokkos::View&lt; Scalar *[4][num_phys_lev][npack], Kokkos::LayoutRight, ExecSpace &gt; LinearSystem</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00061">DirkFunctorImpl.hpp:63</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a756490fb7e2d1d9594c0354c5ab45784"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a756490fb7e2d1d9594c0354c5ab45784">Homme::DirkFunctorImpl::shmem_size</a></div><div class="ttdeci">KOKKOS_INLINE_FUNCTION size_t shmem_size(const int team_size) const</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00093">DirkFunctorImpl.hpp:93</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a81b5136d79fe85b544708cab3a1ca1a2"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a81b5136d79fe85b544708cab3a1ca1a2">Homme::DirkFunctorImpl::calc_whether_ge</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION void calc_whether_ge(const KernelVariables &amp;kv, const int nlev, const int nvec, const Real threshold, const WorkSlot &amp;dphi, const WorkSlot &amp;wrk)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00857">DirkFunctorImpl.hpp:857</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a91451cda2de85e1624b5376c6cae7893"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a91451cda2de85e1624b5376c6cae7893">Homme::DirkFunctorImpl::calc_whether_gt_and_set</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION void calc_whether_gt_and_set(const KernelVariables &amp;kv, const int nlev, const int nvec, const Real threshold, const WorkSlot &amp;dphi, const WorkSlot &amp;wrk)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00834">DirkFunctorImpl.hpp:834</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a9af6e752f61b639e7546ef82462761b3"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a9af6e752f61b639e7546ef82462761b3">Homme::DirkFunctorImpl::Work</a></div><div class="ttdeci">Kokkos::View&lt; Scalar *[num_work][num_lev_aligned][npack], Kokkos::LayoutRight, ExecSpace &gt; Work</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00050">DirkFunctorImpl.hpp:52</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#a9d2fbe5f748c6cfd240046f91c1746b2afbc4eb69ab280fd072aeaa0addbe6549">Homme::DirkFunctorImpl::packn</a></div><div class="ttdeci">@ packn</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00027">DirkFunctorImpl.hpp:27</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_aaa0cba0d780f6f82ef24f5f66efe2339"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#aaa0cba0d780f6f82ef24f5f66efe2339">Homme::DirkFunctorImpl::requested_buffer_size</a></div><div class="ttdeci">int requested_buffer_size() const</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00132">DirkFunctorImpl.hpp:132</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_aac275931d841f7f797dfe8d17d8804faa6a5fe9bdf209c105b47e43d46109c2d3"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#aac275931d841f7f797dfe8d17d8804faa6a5fe9bdf209c105b47e43d46109c2d3">Homme::DirkFunctorImpl::calc_initial_guess_in_newton_kernel</a></div><div class="ttdeci">@ calc_initial_guess_in_newton_kernel</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00034">DirkFunctorImpl.hpp:34</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_aacd66adbf0a65ff852dadd75d96c970c"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#aacd66adbf0a65ff852dadd75d96c970c">Homme::DirkFunctorImpl::run</a></div><div class="ttdeci">void run(int nm1, Real alphadt_nm1, int n0, Real alphadt_n0, int np1, Real dt2, const Elements &amp;e, const HybridVCoord &amp;hvcoord, const bool bfb_solver=default_bfb_solver)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00144">DirkFunctorImpl.hpp:144</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_ab5831cc2145e27a1bdc82cf2dbc94eaf"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#ab5831cc2145e27a1bdc82cf2dbc94eaf">Homme::DirkFunctorImpl::solvebfb</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION void solvebfb(const KernelVariables &amp;kv, const W &amp;dl, const W &amp;d, const W &amp;du, const W &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00767">DirkFunctorImpl.hpp:767</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_ab72c4b923177016f64e0db275c5797c7"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#ab72c4b923177016f64e0db275c5797c7">Homme::DirkFunctorImpl::calc_wmax</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION Real calc_wmax(const KernelVariables &amp;kv, const int nlev, const int nvec, const WorkSlot &amp;w)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00640">DirkFunctorImpl.hpp:640</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_ab84a51a898552b520929b580aec455f1"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#ab84a51a898552b520929b580aec455f1">Homme::DirkFunctorImpl::init_buffers</a></div><div class="ttdeci">void init_buffers(const FunctorsBuffersManager &amp;fbm)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00137">DirkFunctorImpl.hpp:137</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_abc314dac1110aeebebd6d1ca8fa7ee8a"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#abc314dac1110aeebebd6d1ca8fa7ee8a">Homme::DirkFunctorImpl::solve</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION void solve(const KernelVariables &amp;kv, const W &amp;dl, const W &amp;d, const W &amp;du, const W &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00754">DirkFunctorImpl.hpp:754</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_abd9c140e611e21fbaffb60a354828862"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#abd9c140e611e21fbaffb60a354828862">Homme::DirkFunctorImpl::DirkFunctorImpl</a></div><div class="ttdeci">DirkFunctorImpl(const int nelem)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00097">DirkFunctorImpl.hpp:97</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#abfd82bcc96c5b9725a678b522bc33a1da7943d7fbde14c23bf564bd7f8e67d0b8">Homme::DirkFunctorImpl::scaln</a></div><div class="ttdeci">@ scaln</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00028">DirkFunctorImpl.hpp:28</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_ac2a8cf41d71c13c423ab248c1f9426bf"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#ac2a8cf41d71c13c423ab248c1f9426bf">Homme::DirkFunctorImpl::calc_jacobian</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION void calc_jacobian(const KernelVariables &amp;kv, const Real &amp;dt2, const R &amp;dp3d, const R &amp;dphi, const R &amp;pnh, const W &amp;dl, const W &amp;d, const W &amp;du, const int nlev=NUM_PHYSICAL_LEV)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00700">DirkFunctorImpl.hpp:700</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_acc71b9c82c12f01dcbe5b35eb7062030"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#acc71b9c82c12f01dcbe5b35eb7062030">Homme::DirkFunctorImpl::ConstWorkSlot</a></div><div class="ttdeci">Kokkos::View&lt; const Scalar[num_lev_aligned][npack], Kokkos::LayoutRight, ExecSpace, Kokkos::MemoryTraits&lt; Kokkos::Unmanaged &gt; &gt; ConstWorkSlot</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00057">DirkFunctorImpl.hpp:60</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_ad2bb0654a9d028faa8f136f293902a2b"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#ad2bb0654a9d028faa8f136f293902a2b">Homme::DirkFunctorImpl::calc_gwphis</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION void calc_gwphis(const KernelVariables &amp;kv, const R &amp;dp3d, const Rv &amp;v, const Rgphis &amp;gradphis, const Rhybi &amp;hybi, const W &amp;gwh_i, const int nlev=NUM_PHYSICAL_LEV)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00492">DirkFunctorImpl.hpp:492</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_ad42290f30bc15bdcca5d08b09b35b2f5"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#ad42290f30bc15bdcca5d08b09b35b2f5">Homme::DirkFunctorImpl::pnh_and_exner_from_eos</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION void pnh_and_exner_from_eos(const KernelVariables &amp;kv, const HybridVCoord &amp;hvcoord, const R &amp;vtheta_dp, const R &amp;dp3d, const R &amp;dphi, const W &amp;pnh, const W &amp;exner, const Wi &amp;dpnh_dp_i, const int nlev=NUM_PHYSICAL_LEV)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00550">DirkFunctorImpl.hpp:550</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_ae764021a76b604cb4d3a8a890f3c1f33a968488ac9452fe91a8c32c4308a55404"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#ae764021a76b604cb4d3a8a890f3c1f33a968488ac9452fe91a8c32c4308a55404">Homme::DirkFunctorImpl::default_bfb_solver</a></div><div class="ttdeci">@ default_bfb_solver</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00042">DirkFunctorImpl.hpp:40</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_ae7960c37222103c9425822489f3a0ef1"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#ae7960c37222103c9425822489f3a0ef1">Homme::DirkFunctorImpl::exit_on_step</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION bool exit_on_step(const KernelVariables &amp;kv, const int nlev, const int nvec, const Real &amp;wmax, const Real &amp;deltatol, const LinearSystemSlot &amp;x, Real &amp;deltaerr)</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00666">DirkFunctorImpl.hpp:666</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_ae8678dd7d4c0472d9c376710a5bfe54d"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#ae8678dd7d4c0472d9c376710a5bfe54d">Homme::DirkFunctorImpl::m_ig_policy</a></div><div class="ttdeci">TeamPolicy m_ig_policy</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00088">DirkFunctorImpl.hpp:88</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_ae87d36a8fd8bd92c1b960f8896c626d6"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#ae87d36a8fd8bd92c1b960f8896c626d6">Homme::DirkFunctorImpl::m_policy</a></div><div class="ttdeci">TeamPolicy m_policy</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00088">DirkFunctorImpl.hpp:88</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_ae9ad1a5a92392bc26952e613bab3ce51a7985952861706100aa02c53882dc99ba"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#ae9ad1a5a92392bc26952e613bab3ce51a7985952861706100aa02c53882dc99ba">Homme::DirkFunctorImpl::num_lev_aligned</a></div><div class="ttdeci">@ num_lev_aligned</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00031">DirkFunctorImpl.hpp:31</a></div></div>
<div class="ttc" id="astruct_homme_1_1_dirk_functor_impl_html_af2208bbe9fadd70135385d703020814d"><div class="ttname"><a href="struct_homme_1_1_dirk_functor_impl.html#af2208bbe9fadd70135385d703020814d">Homme::DirkFunctorImpl::nslot</a></div><div class="ttdeci">int nslot</div><div class="ttdef"><b>Definition:</b> <a href="_dirk_functor_impl_8hpp_source.html#l00090">DirkFunctorImpl.hpp:90</a></div></div>
<div class="ttc" id="astruct_homme_1_1_functors_buffers_manager_html"><div class="ttname"><a href="struct_homme_1_1_functors_buffers_manager.html">Homme::FunctorsBuffersManager</a></div><div class="ttdef"><b>Definition:</b> <a href="_functors_buffers_manager_8hpp_source.html#l00015">FunctorsBuffersManager.hpp:15</a></div></div>
<div class="ttc" id="astruct_homme_1_1_functors_buffers_manager_html_ad255e5d3e2743ce109d316c596f30e4d"><div class="ttname"><a href="struct_homme_1_1_functors_buffers_manager.html#ad255e5d3e2743ce109d316c596f30e4d">Homme::FunctorsBuffersManager::get_memory</a></div><div class="ttdeci">Real * get_memory() const</div><div class="ttdef"><b>Definition:</b> <a href="_functors_buffers_manager_8hpp_source.html#l00022">FunctorsBuffersManager.hpp:22</a></div></div>
<div class="ttc" id="astruct_homme_1_1_kernel_variables_html"><div class="ttname"><a href="struct_homme_1_1_kernel_variables.html">Homme::KernelVariables</a></div><div class="ttdef"><b>Definition:</b> <a href="_kernel_variables_8hpp_source.html#l00015">KernelVariables.hpp:15</a></div></div>
<div class="ttc" id="astruct_homme_1_1_kernel_variables_html_a3191a82ad3209763dfd817720ea68ab5"><div class="ttname"><a href="struct_homme_1_1_kernel_variables.html#a3191a82ad3209763dfd817720ea68ab5">Homme::KernelVariables::ie</a></div><div class="ttdeci">int ie</div><div class="ttdef"><b>Definition:</b> <a href="_kernel_variables_8hpp_source.html#l00152">KernelVariables.hpp:152</a></div></div>
<div class="ttc" id="astruct_homme_1_1_kernel_variables_html_a4ad2f818910f49f36d7474dbb75f7100"><div class="ttname"><a href="struct_homme_1_1_kernel_variables.html#a4ad2f818910f49f36d7474dbb75f7100">Homme::KernelVariables::team_idx</a></div><div class="ttdeci">const int team_idx</div><div class="ttdef"><b>Definition:</b> <a href="_kernel_variables_8hpp_source.html#l00153">KernelVariables.hpp:153</a></div></div>
<div class="ttc" id="astruct_homme_1_1_kernel_variables_html_a7a205f05488de1a2b43e43f282007593"><div class="ttname"><a href="struct_homme_1_1_kernel_variables.html#a7a205f05488de1a2b43e43f282007593">Homme::KernelVariables::team</a></div><div class="ttdeci">const TeamMember &amp; team</div><div class="ttdef"><b>Definition:</b> <a href="_kernel_variables_8hpp_source.html#l00146">KernelVariables.hpp:146</a></div></div>
<div class="ttc" id="astruct_homme_1_1_kernel_variables_html_aed04848b4565ee447b2d9e5e64f4ba58"><div class="ttname"><a href="struct_homme_1_1_kernel_variables.html#aed04848b4565ee447b2d9e5e64f4ba58">Homme::KernelVariables::shmem_size</a></div><div class="ttdeci">static KOKKOS_INLINE_FUNCTION size_t shmem_size(int team_size)</div><div class="ttdef"><b>Definition:</b> <a href="_kernel_variables_8hpp_source.html#l00141">KernelVariables.hpp:141</a></div></div>
<div class="ttc" id="astruct_homme_1_1_kernel_variables_html_aff37ae38e7e4f4bc28b72fe167572cd6"><div class="ttname"><a href="struct_homme_1_1_kernel_variables.html#aff37ae38e7e4f4bc28b72fe167572cd6">Homme::KernelVariables::team_barrier</a></div><div class="ttdeci">KOKKOS_FORCEINLINE_FUNCTION void team_barrier() const</div><div class="ttdef"><b>Definition:</b> <a href="_kernel_variables_8hpp_source.html#l00148">KernelVariables.hpp:148</a></div></div>
<div class="ttc" id="astruct_homme_1_1_on_gpu_html"><div class="ttname"><a href="struct_homme_1_1_on_gpu.html">Homme::OnGpu</a></div><div class="ttdef"><b>Definition:</b> <a href="_exec_space_defs_8hpp_source.html#l00073">ExecSpaceDefs.hpp:73</a></div></div>
<div class="ttc" id="astruct_homme_1_1_thread_preferences_html"><div class="ttname"><a href="struct_homme_1_1_thread_preferences.html">Homme::ThreadPreferences</a></div><div class="ttdef"><b>Definition:</b> <a href="_exec_space_defs_8hpp_source.html#l00095">ExecSpaceDefs.hpp:95</a></div></div>
<div class="ttc" id="astruct_homme_1_1_thread_preferences_html_a0795fa24c05258def544b18e0c32bd8c"><div class="ttname"><a href="struct_homme_1_1_thread_preferences.html#a0795fa24c05258def544b18e0c32bd8c">Homme::ThreadPreferences::max_threads_usable</a></div><div class="ttdeci">int max_threads_usable</div><div class="ttdef"><b>Definition:</b> <a href="_exec_space_defs_8hpp_source.html#l00097">ExecSpaceDefs.hpp:97</a></div></div>
<div class="ttc" id="astruct_homme_1_1_thread_preferences_html_a29fca994cc460c1d4b4f2bad88cb80a2"><div class="ttname"><a href="struct_homme_1_1_thread_preferences.html#a29fca994cc460c1d4b4f2bad88cb80a2">Homme::ThreadPreferences::prefer_larger_team</a></div><div class="ttdeci">bool prefer_larger_team</div><div class="ttdef"><b>Definition:</b> <a href="_exec_space_defs_8hpp_source.html#l00103">ExecSpaceDefs.hpp:103</a></div></div>
<div class="ttc" id="astruct_homme_1_1_thread_preferences_html_a9765cdd2b5e5c1f5a949e891930bbfae"><div class="ttname"><a href="struct_homme_1_1_thread_preferences.html#a9765cdd2b5e5c1f5a949e891930bbfae">Homme::ThreadPreferences::max_vectors_usable</a></div><div class="ttdeci">int max_vectors_usable</div><div class="ttdef"><b>Definition:</b> <a href="_exec_space_defs_8hpp_source.html#l00099">ExecSpaceDefs.hpp:99</a></div></div>
<div class="ttc" id="astruct_homme_1_1_thread_preferences_html_ac95711d45065769156632a039ccd4ddf"><div class="ttname"><a href="struct_homme_1_1_thread_preferences.html#ac95711d45065769156632a039ccd4ddf">Homme::ThreadPreferences::prefer_threads</a></div><div class="ttdeci">bool prefer_threads</div><div class="ttdef"><b>Definition:</b> <a href="_exec_space_defs_8hpp_source.html#l00101">ExecSpaceDefs.hpp:101</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_427927cf201030fc009b80d07eae9e21.html">theta-l_kokkos</a></li><li class="navelem"><a class="el" href="dir_e56007d24017eb8477b659f6292a676b.html">cxx</a></li><li class="navelem"><a class="el" href="_dirk_functor_impl_8hpp.html">DirkFunctorImpl.hpp</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
